<!DOCTYPE html>
<!--
  í† ì§€ì •ë³´ ì¡°íšŒ ì‹œìŠ¤í…œ
  Copyright (c) 2025 landinfo. All rights reserved.
  ë¬´ë‹¨ ë³µì œ, ë°°í¬, ìˆ˜ì •ì„ ê¸ˆí•©ë‹ˆë‹¤.
  Unauthorized copying, distribution, or modification of this software is prohibited.
-->
<html style="height:100%;margin:0;padding:0;">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="robots" content="noindex, noarchive, nosnippet"/>
<meta name="google-adsense-account" content="ca-pub-4187457564577316">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4187457564577316" crossorigin="anonymous"></script>
<title>í† ì§€ì •ë³´ ì¡°íšŒ ì‹œìŠ¤í…œ</title>
<script src="https://map.vworld.kr/js/vworldMapInit.js.do?version=2.0&apiKey=A12CEDAE-86F1-3453-BC92-3FD98BE14103"></script>
<script src="https://map.vworld.kr/js/webglMapInit.js.do?version=3.0&apiKey=A12CEDAE-86F1-3453-BC92-3FD98BE14103"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
<script src="https://ecvam.neins.go.kr/apiConfirm.do?APIKEY=MUTW-PGHX-76CT-ENMD"></script>
<style>
*{box-sizing:border-box;}
html,body{height:100%;margin:0;padding:0;overflow:hidden;font-family:'Malgun Gothic','Apple SD Gothic Neo',sans-serif;font-size:13px;}
.wrap{display:flex;height:100vh;width:100vw;}

/* â”€â”€ ì§€ë„ ì˜ì—­ â”€â”€ */
.map-area{flex:1;position:relative;height:100%;}
#vmap,#ol3map{width:100%;height:100%;position:absolute;top:0;left:0;}
.map-ctrl{position:absolute;top:10px;left:10px;z-index:999;background:rgba(255,255,255,.92);border-radius:8px;padding:6px 10px;box-shadow:0 2px 8px rgba(0,0,0,.2);}
.map-ctrl select{border:none;background:transparent;font-weight:600;font-size:13px;cursor:pointer;outline:none;}

/* â”€â”€ ì‚¬ì´ë“œ íŒ¨ë„ â”€â”€ */
.side{width:360px;min-width:300px;display:flex;flex-direction:column;height:100%;border-left:2px solid #dde1f0;background:#f4f6fb;overflow:hidden;}

/* í—¤ë” */
.hd{background:linear-gradient(135deg,#3a7bd5,#00d2ff);color:#fff;padding:16px 18px;flex-shrink:0;}
.hd h1{margin:0;font-size:17px;font-weight:700;}
.hd p{margin:4px 0 0;font-size:11px;opacity:.85;}

/* ê²€ìƒ‰ */
.search-row{display:flex;gap:6px;padding:12px;background:#fff;border-bottom:1px solid #e0e4f0;flex-shrink:0;position:relative;}
.search-row input{flex:1;padding:8px 10px;border:1px solid #c5cde0;border-radius:6px;font-size:13px;outline:none;}
.search-row input:focus{border-color:#3a7bd5;}
.search-row button{padding:8px 14px;background:linear-gradient(135deg,#3a7bd5,#00d2ff);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;white-space:nowrap;}

/* ë²„íŠ¼ ê·¸ë£¹ */
.btn-row{display:flex;gap:8px;padding:10px 12px;background:#fff;border-bottom:1px solid #e0e4f0;flex-shrink:0;}
.btn-row button{flex:1;padding:8px 4px;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;color:#fff;}
.btn-export{background:linear-gradient(135deg,#11998e,#38ef7d);}
.btn-table-win{background:linear-gradient(135deg,#4776E6,#8E54E9);}
.btn-clear{background:linear-gradient(135deg,#f7971e,#ffd200);color:#333!important;}

/* ì˜µì…˜ í…Œì´ë¸” */
.opt-table{width:100%;padding:10px 12px;background:#fff;border-bottom:1px solid #e0e4f0;flex-shrink:0;}
.opt-table table{width:100%;border-collapse:collapse;}
.opt-table th{text-align:left;padding:5px 6px;color:#555;font-weight:600;width:48%;}
.opt-table td{padding:5px 6px;}
.opt-table td span{font-weight:600;color:#3a7bd5;}

/* ì£¼ì œë„ íŒ¨ë„ */
.theme-panel{padding:10px 12px;background:#fff;border-bottom:1px solid #e0e4f0;flex-shrink:0;}
.theme-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.theme-hd-title{font-weight:700;color:#333;font-size:13px;}
.toggle-btn{padding:3px 10px;background:#e8edf5;border:1px solid #c0c8dc;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;}
#themeList{display:none;max-height:180px;overflow-y:auto;}
.theme-item{display:flex;align-items:center;gap:6px;padding:4px 2px;border-bottom:1px solid #f0f3fb;cursor:grab;user-select:none;}
.theme-item:hover{background:#f4f7ff;}
.theme-item label{flex:1;cursor:pointer;font-size:12px;}
.drag-handle{color:#aaa;font-size:14px;cursor:grab;}

/* ìƒíƒœ ë©”ì‹œì§€ */
.status-bar{margin:8px 12px;padding:8px 10px;background:#e8f4fd;border-left:3px solid #3a7bd5;border-radius:4px;font-size:12px;color:#1a5fa8;display:none;}
.status-bar.ok{background:#e6f9ef;border-left-color:#27ae60;color:#1a7a42;}
.status-bar.err{background:#fdecea;border-left-color:#e74c3c;color:#c0392b;}

/* ECVAM í™˜ê²½ì„±í‰ê°€ ë“±ê¸‰ ë°°ì§€ */
.ecvam-badge{display:inline-block;padding:1px 7px;border-radius:9px;font-size:11px;font-weight:700;color:#fff;}
.ecvam-gr1{background:#006633;}.ecvam-gr2{background:#339966;}
.ecvam-gr3{background:#BBAA00;color:#fff;}.ecvam-gr4{background:#CC6600;}
.ecvam-gr5{background:#CC3300;}
.ecvam-link{font-size:10px;color:#3a7bd5;text-decoration:underline;cursor:pointer;}
/* ECVAM ë²”ë¡€ */
.ecvam-legend{display:flex;gap:4px;flex-wrap:wrap;padding:2px 12px 6px;}

/* ì¹´ìš´íŠ¸ */
.cnt-bar{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;flex-shrink:0;}
.cnt-bar .ttl{font-weight:700;font-size:13px;color:#333;}
.cnt-badge{background:linear-gradient(135deg,#3a7bd5,#00d2ff);color:#fff;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:700;}
/* ì •ë ¬ ë²„íŠ¼ */
.sort-btn{padding:2px 7px;border:1px solid #b0bcd8;border-radius:4px;background:#f0f4ff;color:#3a7bd5;font-size:10px;font-weight:700;cursor:pointer;white-space:nowrap;}
.sort-btn.active{background:#3a7bd5;color:#fff;border-color:#3a7bd5;}

/* í† ì§€ ëª©ë¡ */
.land-list{flex:1;overflow-y:auto;padding:0 12px 12px;}
.land-item{margin-bottom:10px;background:#fff;border:1px solid #dde3f5;border-radius:8px;box-shadow:0 1px 4px rgba(60,80,180,.07);transition:box-shadow .2s;}
.land-item:hover{box-shadow:0 4px 14px rgba(60,80,180,.15);}
.land-item-hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px 8px;border-bottom:2px solid #f0f3fb;gap:4px;}
.land-item-hd span{color:#3a7bd5;font-weight:700;font-size:13px;flex:1;margin-right:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.del-btn{padding:3px 9px;background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap;}
.newwin-btn{padding:3px 8px;background:linear-gradient(135deg,#4776E6,#8E54E9);color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap;}
/* í† ì§€ ì¹´ë“œ - ì‹¬í”Œ key:value ê·¸ë¦¬ë“œ */
.land-kv{padding-bottom:4px;}
.land-kv-sec{padding:3px 12px;font-size:10px;font-weight:700;color:#3a7bd5;background:#f0f4ff;letter-spacing:.3px;}
.land-kv-row{display:flex;justify-content:space-between;align-items:baseline;padding:4px 12px;border-bottom:1px solid #f5f7ff;}
.land-kv-row:last-child{border-bottom:none;}
.land-kv-k{color:#777;font-weight:600;min-width:90px;flex-shrink:0;font-size:11px;}
.land-kv-v{color:#1a1a2e;font-weight:700;text-align:right;word-break:break-all;font-size:12px;}

/* ëª¨ë°”ì¼ í…Œì´ë¸” (ë°ìŠ¤í¬íƒ‘ì—ì„œ í•­ìƒ ìˆ¨ê¹€ - !importantë¡œ JS inline style ë°©ì§€) */
.mob-land-tbl-wrap{display:none!important;}

/* ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ ë“œë¡­ë‹¤ìš´ */
.addr-results{position:absolute;left:0;right:0;top:100%;z-index:9999;background:#fff;border:1px solid #c5cde0;border-top:none;border-radius:0 0 8px 8px;box-shadow:0 4px 16px rgba(60,80,180,.15);max-height:220px;overflow-y:auto;}
.addr-result-item{padding:9px 12px;font-size:12px;color:#333;cursor:pointer;border-bottom:1px solid #f0f3fb;display:flex;flex-direction:column;gap:2px;}
.addr-result-item:last-child{border-bottom:none;}
.addr-result-item:hover{background:#f0f4ff;}
.addr-result-name{font-weight:600;color:#1a3580;}
.addr-result-addr{font-size:11px;color:#888;}


/* â”€â”€ ë„ì›€ë§ ë²„íŠ¼ â”€â”€ */
.help-btn{position:absolute;top:14px;right:14px;width:28px;height:28px;background:rgba(255,255,255,.25);border:2px solid rgba(255,255,255,.7);border-radius:50%;color:#fff;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1;transition:background .2s;}
.help-btn:hover{background:rgba(255,255,255,.45);}

/* â”€â”€ ë„ì›€ë§ ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ â”€â”€ */
#helpModal{display:none;position:fixed;inset:0;z-index:9999;background:rgba(10,20,50,.55);backdrop-filter:blur(3px);}
#helpModal.open{display:flex;align-items:center;justify-content:center;}
.help-modal-box{background:#fff;border-radius:14px;width:min(680px,96vw);max-height:90vh;display:flex;flex-direction:column;box-shadow:0 8px 40px rgba(0,0,0,.3);overflow:hidden;}
.help-modal-hd{background:linear-gradient(135deg,#3a7bd5,#00d2ff);color:#fff;padding:18px 22px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.help-modal-hd h2{margin:0;font-size:17px;font-weight:700;}
.help-modal-hd p{margin:4px 0 0;font-size:11px;opacity:.85;}
.help-modal-close{background:rgba(255,255,255,.2);border:none;color:#fff;font-size:18px;cursor:pointer;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;}
.help-modal-close:hover{background:rgba(255,255,255,.4);}
.help-modal-body{overflow-y:auto;padding:20px 22px 24px;flex:1;}
.help-modal-body::-webkit-scrollbar{width:5px;}
.help-modal-body::-webkit-scrollbar-thumb{background:#b0bcd8;border-radius:3px;}

/* ì„¹ì…˜ */
.hm-sec{margin-bottom:22px;}
.hm-sec-title{font-size:14px;font-weight:700;color:#2255a4;border-left:4px solid #3a7bd5;padding-left:10px;margin-bottom:10px;}
.hm-row{display:flex;gap:8px;margin-bottom:7px;align-items:flex-start;}
.hm-icon{font-size:18px;flex-shrink:0;width:26px;text-align:center;margin-top:1px;}
.hm-text{font-size:12px;color:#333;line-height:1.6;}
.hm-text strong{color:#1a3a80;font-weight:700;}
.hm-badge{display:inline-block;padding:1px 7px;border-radius:10px;font-size:10px;font-weight:700;color:#fff;background:#3a7bd5;margin:0 2px;}
.hm-badge.green{background:#27ae60;}.hm-badge.orange{background:#e67e22;}.hm-badge.purple{background:#8e44ad;}.hm-badge.red{background:#e74c3c;}
.hm-tip{background:#f0f6ff;border:1px solid #c8daff;border-radius:6px;padding:8px 12px;font-size:11px;color:#2255a4;margin-top:6px;line-height:1.7;}
.hm-divider{border:none;border-top:1px solid #eee;margin:18px 0;}
.hm-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:6px;}
.hm-table th{background:#f0f4ff;color:#2255a4;font-weight:700;padding:6px 10px;text-align:left;border:1px solid #dde3f5;}
.hm-table td{padding:6px 10px;border:1px solid #eef1fb;color:#333;line-height:1.5;}
.hm-table tr:nth-child(even) td{background:#fafbff;}

/* ëª¨ë°”ì¼ ë„ì›€ë§ ëª¨ë‹¬ */
@media(max-width:768px){
  .help-modal-box{width:100%;max-height:100vh;border-radius:16px 16px 0 0;position:fixed;bottom:0;left:0;right:0;}
  #helpModal.open{align-items:flex-end;}
  .help-modal-body{padding:14px 16px 20px;}
  .help-modal-hd{padding:14px 16px;}
}

/* ìŠ¤í¬ë¡¤ë°” */
.land-list::-webkit-scrollbar{width:6px;}
.land-list::-webkit-scrollbar-track{background:#f0f3fb;}
.land-list::-webkit-scrollbar-thumb{background:#b0bcd8;border-radius:3px;}

/* ë©´ì  í•©ê³„ ë°” */
.area-sum-bar{display:flex;justify-content:space-between;align-items:center;padding:7px 12px;background:linear-gradient(135deg,#e8f4fd,#d4eaf8);border-top:1px solid #b8d6ee;border-bottom:1px solid #b8d6ee;flex-shrink:0;}
.area-sum-label{font-size:12px;font-weight:600;color:#1a5fa8;}
.area-sum-val{font-size:14px;font-weight:700;color:#1a5fa8;letter-spacing:-.3px;}

/* footer */
.footer{padding:8px 12px;font-size:10px;color:#aaa;border-top:1px solid #e0e4f0;flex-shrink:0;}

/* ì§€ë„ ë§ˆìš°ìŠ¤ ì˜¤ë²„ íˆ´íŒ */
#mapTooltip{position:absolute;z-index:1000;background:rgba(15,20,40,0.82);color:#fff;padding:4px 10px;border-radius:5px;font-size:11px;font-weight:600;pointer-events:none;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.3);display:none;max-width:260px;letter-spacing:.2px;}

/* ì§€ì ë„ ì¤Œ ê²½ê³  ë°°ë„ˆ */
#zoomWarn{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);z-index:998;background:rgba(211,84,0,0.91);color:#fff;padding:7px 20px;border-radius:20px;font-size:12px;font-weight:700;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,.28);display:none;pointer-events:none;letter-spacing:.3px;}
@media(max-width:768px){#zoomWarn{bottom:8px;font-size:11px;padding:6px 14px;}}

/* ë¹ˆ ìƒíƒœ */
.empty-state{text-align:center;padding:40px 20px;color:#aab;}
.empty-state .ico{font-size:36px;margin-bottom:10px;}

/* â”€â”€ ëª¨ë°”ì¼ bottom sheet â”€â”€ */
.sheet-pull{display:none;} /* ë°ìŠ¤í¬íƒ‘ì—ì„œ ìˆ¨ê¹€ */

@media(max-width:768px){
  /* ë ˆì´ì•„ì›ƒ ì¬ì„¤ì • */
  .wrap{display:block;position:relative;}

  /* ì§€ë„: ìƒë‹¨ 55vh ê³ ì • (íŒ¨ë„ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ) */
  .map-area{
    position:fixed;
    top:0;left:0;right:0;
    height:55vh;
    z-index:1;
  }

  /* ì‚¬ì´ë“œ: ì§€ë„ ë°”ë¡œ ì•„ë˜ (55vh~100vh) */
  .side{
    position:fixed;
    top:55vh;
    bottom:0;left:0;right:0;
    width:100%;
    height:45vh;
    min-width:unset;
    z-index:100;
    border-left:none;
    border-radius:16px 16px 0 0;
    box-shadow:0 -4px 24px rgba(0,0,0,.25);
    background:#f4f6fb;
    overflow:hidden;
    transition:transform .3s cubic-bezier(.25,.8,.25,1);
  }
  /* íŒ¨ë„ ìˆ¨ê¸°ê¸° (í•¸ë“¤ë§Œ ë…¸ì¶œ - ì„ íƒì ) */
  .side.sheet-collapsed{
    transform:translateY(calc(100% - 44px));
  }

  /* í•¸ë“¤ ë°” */
  .sheet-pull{
    display:flex;
    align-items:center;
    gap:8px;
    padding:8px 14px;
    background:#fff;
    border-bottom:1px solid #eee;
    cursor:pointer;
    flex-shrink:0;
    border-radius:16px 16px 0 0;
    order:1;
  }
  .sheet-pull-bar{
    flex-shrink:0;width:36px;height:4px;
    background:#ddd;border-radius:2px;
  }
  .sheet-pull-label{
    flex:1;font-size:12px;color:#555;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .sheet-pull-toggle{font-size:15px;color:#3a7bd5;font-weight:700;}

  /* í—¤ë”: íŒ¨ë„ ê³µê°„ ì ˆì•½ì„ ìœ„í•´ ìˆ¨ê¹€ (sheet-pull ë ˆì´ë¸”ë¡œ ëŒ€ì²´) */
  .hd{display:none!important;}

  /* ì˜µì…˜/í‘¸í„° ìˆ¨ê¹€ (ì£¼ì œë„ëŠ” í‘œì‹œ) */
  .opt-table,.footer{display:none!important;}

  /* ì£¼ì œë„ íŒ¨ë„: ëª¨ë°”ì¼ ì»´íŒ©íŠ¸ */
  .theme-panel{padding:3px 8px;border-bottom:1px solid #e0e4f0;order:10;}
  .theme-hd-title{font-size:11px;}
  .toggle-btn{padding:2px 7px;font-size:10px;}
  #themeList{max-height:90px;}
  #ecvamThemeList{max-height:90px;}
  .theme-item{padding:2px 2px;}
  .theme-item label{font-size:11px;}
  .ecvam-legend{padding:2px 8px 4px;}

  /* ê²€ìƒ‰ */
  .search-row{padding:5px 8px;gap:4px;order:2;}
  .search-row input{padding:5px 8px;font-size:12px;}
  .search-row button{padding:5px 8px;font-size:12px;}

  /* ë²„íŠ¼ */
  .btn-row{padding:4px 8px;gap:4px;order:8;}
  .btn-row button{padding:5px 2px;font-size:10px;}

  /* ìƒíƒœ ë©”ì‹œì§€ */
  .status-bar{order:3;}

  /* ì¹´ìš´íŠ¸/ë©´ì  */
  .cnt-bar{padding:4px 10px;order:5;}
  .cnt-bar .ttl{font-size:11px;}
  .area-sum-bar{padding:4px 10px;order:6;}
  .area-sum-label{font-size:11px;}
  .area-sum-val{font-size:12px;}

  /* í† ì§€ ëª©ë¡: ë‚¨ì€ ê³µê°„ */
  .land-list{
    padding:0 8px 8px;
    -webkit-overflow-scrolling:touch;
    overscroll-behavior:contain;
    order:4;
    height: auto;
    overflow: visible;
  }

  /* ì‚¬ì´ë“œ íŒ¨ë„ ë‚´ë¶€ ìŠ¤í¬ë¡¤ í—ˆìš© */
  .side{
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  /* â”€â”€ ëª¨ë°”ì¼: ì¹´ë“œ ìˆ¨ê¸°ê³  í…Œì´ë¸”ë§Œ í‘œì‹œ â”€â”€ */
  .land-item{display:none!important;}
  .land-item-hd{display:none!important;}
  /* ëª¨ë°”ì¼ í…Œì´ë¸” (ë°ì´í„° ìˆì„ ë•Œë§Œ í‘œì‹œ) */
  .mob-land-tbl-wrap.active{display:block!important;position:relative;overflow-x:auto;margin:8px 0;border-radius:8px;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.1);border:1px solid #dde3f5;}
  /* ì˜¤ë¥¸ìª½ ìŠ¤í¬ë¡¤ íŒíŠ¸ ê·¸ë¼ë°ì´ì…˜ */
  .mob-land-tbl-wrap::after{content:'';pointer-events:none;position:absolute;top:0;right:0;bottom:0;width:36px;background:linear-gradient(to right,rgba(255,255,255,0),rgba(255,255,255,.95));border-radius:0 8px 8px 0;z-index:3;transition:opacity .3s;}
  .mob-land-tbl-wrap.scrolled::after{opacity:0;}
  /* ìŠ¤í¬ë¡¤ íŒíŠ¸ í™”ì‚´í‘œ ë°°ì§€ */
  .mob-scroll-hint{position:sticky;right:4px;display:inline-block;background:#3a7bd5;color:#fff;font-size:10px;padding:2px 5px;border-radius:10px;margin:4px 4px 4px 0;float:right;opacity:.85;}
  .mob-land-tbl{width:100%;border-collapse:collapse;white-space:nowrap;}
  .mob-land-tbl thead th{background:#3a7bd5;color:#fff;padding:7px 6px;text-align:center;font-size:10px;font-weight:700;position:sticky;top:0;z-index:2;}
  .mob-land-tbl tbody td{padding:6px 5px;border-bottom:1px solid #eef1fb;text-align:center;color:#222;font-size:11px;}
  .mob-land-tbl tbody tr{cursor:pointer;}
  .mob-land-tbl tbody tr:hover td{background:#deeaff!important;}
  .mob-land-tbl tbody tr:nth-child(even) td{background:#f7f9ff;}
  .mob-land-tbl tbody tr:last-child td{border-bottom:none;}
  .mob-del-btn{padding:2px 6px;background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:10px;font-weight:600;}
}
</style>
</head>
<body>
<div class="wrap">

  <!-- ì§€ë„ ì˜ì—­ -->
  <div class="map-area">
    <div id="vmap" style="display:none;"></div>
    <div id="ol3map"></div>
    <div id="mapTooltip"></div>
    <div id="zoomWarn">ğŸ” í™•ëŒ€í•´ì•¼ ì§€ì ì„ ì´ ë³´ì…ë‹ˆë‹¤</div>
    <div class="map-ctrl">
      <select id="mapTypeSel" onchange="changeMapType()">
        <option value="2d" selected>ğŸ—º 2D ì¼ë°˜ì§€ë„</option>
        <option value="3d">ğŸŒ 3D ì§€ë„</option>
      </select>
    </div>
  </div>

  <!-- ì‚¬ì´ë“œ íŒ¨ë„ -->
  <div class="side" id="sidePanel">

    <!-- ëª¨ë°”ì¼ bottom sheet í•¸ë“¤ -->
    <div class="sheet-pull" id="sheetPull" onclick="toggleMobileSheet()">
      <div class="sheet-pull-bar"></div>
      <span class="sheet-pull-label" id="sheetPullLabel">í† ì§€ì •ë³´ë¥¼ í´ë¦­í•˜ì—¬ ì¡°íšŒí•˜ì„¸ìš”</span>
      <span class="sheet-pull-toggle" id="sheetPullToggle">â–¼</span>
    </div>

    <!-- í—¤ë” -->
    <div class="hd" style="position:relative;">
      <h1>ğŸ› í† ì§€ì •ë³´ ì¡°íšŒ ì‹œìŠ¤í…œ</h1>
      <p>VWorld API ê¸°ë°˜ ì§€ì ì •ë³´ Â· ìš©ë„ì§€ì—­ Â· ì§€êµ¬ë‹¨ìœ„ Â· ê·œì œí˜„í™© ì¡°íšŒ</p>
      <button class="help-btn" onclick="openHelp()" title="ì‚¬ìš©ì„¤ëª…ì„œ">?</button>
    </div>

    <!-- ì£¼ì†Œ ê²€ìƒ‰ -->
    <div class="search-row">
      <input id="addrInput" type="text" placeholder="ì£¼ì†Œ ì…ë ¥ (ì˜ˆ: íŒêµë¡œ 242, ì„œìš¸ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 837)"/>
      <button onclick="searchAddress()">ğŸ” ê²€ìƒ‰</button>
    </div>

    <!-- ë‚´ë³´ë‚´ê¸°/ì§€ìš°ê¸° -->
    <div class="btn-row">
      <button class="btn-export" onclick="exportToCSV()">ğŸ’¾ í† ì§€ì¡°ì„œ ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn-table-win" onclick="openTableWindow()">ğŸ“‹ í† ì§€ëª©ë¡ë³´ê¸°</button>
      <button class="btn-clear" onclick="clearLandInfo()">ğŸ—‘ ì „ì²´ ì‚­ì œ</button>
    </div>

    <!-- ì˜µì…˜ -->
    <div class="opt-table">
      <table>
        <tr>
          <th>ì§€ë„ íƒ€ì…</th>
          <td><span id="currentMapType">2D ì¼ë°˜ì§€ë„</span></td>
        </tr>
        <tr id="bldRow" style="display:none;">
          <th>ê±´ë¬¼ ë ˆì´ì–´</th>
          <td><input id="bldChk" type="checkbox" checked onchange="checkLayer(this,'facility_build')"> í‘œì‹œ</td>
        </tr>
        <tr>
          <th>í† ì§€ì •ë³´ ì¡°íšŒ</th>
          <td><input id="landChk" type="checkbox" onchange="toggleLandParcel(this.checked)"> í™œì„±í™”</td>
        </tr>
      </table>
    </div>

    <!-- êµ­í† ê³„íš ì£¼ì œë„ -->
    <div class="theme-panel">
      <div class="theme-hd">
        <span class="theme-hd-title">ğŸ“‹ êµ­í† ê³„íš ì£¼ì œë„</span>
        <button class="toggle-btn" onclick="toggleThemePanel()">í¼ì¹˜ê¸°</button>
      </div>
      <div id="themeList"></div>
    </div>

    <!-- ECVAM í™˜ê²½ì„±í‰ê°€ ì£¼ì œë„ -->
    <div class="theme-panel" id="ecvamPanel">
      <div class="theme-hd">
        <span class="theme-hd-title">ğŸŒ¿ êµ­í† í™˜ê²½ì„±í‰ê°€ ì£¼ì œë„</span>
        <button class="toggle-btn" id="ecvamToggleBtn" onclick="toggleEcvamPanel()">í¼ì¹˜ê¸°</button>
      </div>
      <div id="ecvamThemeList" style="display:none;">
        <!-- ë“±ê¸‰ ë²”ë¡€ -->
        <div class="ecvam-legend">
          <span class="ecvam-badge ecvam-gr1">1ë“±ê¸‰</span>
          <span class="ecvam-badge ecvam-gr2">2ë“±ê¸‰</span>
          <span class="ecvam-badge ecvam-gr3">3ë“±ê¸‰</span>
          <span class="ecvam-badge ecvam-gr4">4ë“±ê¸‰</span>
          <span class="ecvam-badge ecvam-gr5">5ë“±ê¸‰</span>
          <span style="font-size:9px;color:#999;align-self:center;">(1=ë³´ì „â†‘)</span>
        </div>
      </div>
    </div>

    <!-- ìƒíƒœ ë©”ì‹œì§€ -->
    <div class="status-bar" id="statusBar"></div>

    <!-- ì¹´ìš´íŠ¸ + ë©´ì  í•©ê³„ -->
    <div class="cnt-bar">
      <span class="ttl">ğŸ“‚ ìˆ˜ì§‘ëœ í† ì§€ ì •ë³´</span>
      <div style="display:flex;align-items:center;gap:4px;">
        <button class="sort-btn active" id="sortNewest" onclick="setSortMode('newest')">ìµœì‹ ìˆœ</button>
        <button class="sort-btn" id="sortJibunAsc" onclick="setSortMode('jibun_asc')">ì§€ë²ˆâ–²</button>
        <button class="sort-btn" id="sortJibunDesc" onclick="setSortMode('jibun_desc')">ì§€ë²ˆâ–¼</button>
        <span class="cnt-badge" id="landCnt">ì´ 0ê±´</span>
      </div>
    </div>
    <div class="area-sum-bar" id="areaSumBar" style="display:none; flex-direction:column; gap:4px; align-items:stretch;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span class="area-sum-label">ğŸ“ <span id="areaCnt">0</span>í•„ì§€ ë©´ì  í•©ê³„</span>
        <span class="area-sum-val" id="areaSumVal">0 ã¡</span>
      </div>
      <div id="jigaSumRow" style="display:flex; justify-content:space-between; align-items:center; border-top:1px dashed rgba(26,95,168,0.2); padding-top:4px; margin-top:2px;">
        <span class="area-sum-label">ğŸ’° ê³µì‹œì§€ê°€ ì´ì•¡
          <select id="jigaUnitSel" onchange="changeJigaUnit(this.value)" style="margin-left:5px;border:1px solid #b8d6ee;border-radius:4px;background:#eaf3fb;color:#1a5fa8;font-size:10px;font-weight:700;padding:1px 3px;cursor:pointer;outline:none;">
            <option value="ì›">ì›</option>
            <option value="ì²œì›">ì²œì›</option>
            <option value="ë°±ë§Œì›">ë°±ë§Œì›</option>
            <option value="ì–µì›">ì–µì›</option>
          </select>
        </span>
        <span class="area-sum-val" id="jigaSumVal" style="color:#e67e22;">0 ì›</span>
      </div>
    </div>

    <!-- í† ì§€ ëª©ë¡ -->
    <div class="land-list" id="landList">
      <!-- ëª¨ë°”ì¼ í…Œì´ë¸” (mobile only - .active í´ë˜ìŠ¤ë¡œ ì œì–´) -->
      <div id="mobLandTableWrap" class="mob-land-tbl-wrap">
        <div style="padding:3px 8px 2px;font-size:10px;color:#3a7bd5;font-weight:600;display:flex;align-items:center;gap:4px;">
          <span>ğŸ“‹ í† ì§€ ëª©ë¡</span>
          <span style="margin-left:auto;font-size:10px;color:#888;">â† ì¢Œìš° ìŠ¤í¬ë¡¤ë¡œ ë” ë³´ê¸° â†’</span>
        </div>
        <table class="mob-land-tbl">
          <thead>
            <tr>
              <th>ìˆœë²ˆ</th>
              <th>í–‰ì •ë™/ì§€ë²ˆ</th>
              <th>ì§€ëª©</th>
              <th>ë©´ì (ã¡)</th>
              <th>ìš©ë„ì§€ì—­</th>
              <th>ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="mobLandTbody"></tbody>
        </table>
      </div>
      <div class="empty-state">
        <div class="ico">ğŸ“</div>
        <p>ì§€ë„ì—ì„œ í† ì§€ë¥¼ í´ë¦­í•˜ë©´<br>ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
      </div>
    </div>

    <div class="footer">Â© 2025 í† ì§€ì •ë³´ì¡°íšŒì‹œìŠ¤í…œ Â· Powered by VWorld API</div>
  </div>
</div>

<!-- ====================================================
     ë„ì›€ë§ ëª¨ë‹¬
===================================================== -->
<div id="helpModal" onclick="closeHelpOutside(event)">
  <div class="help-modal-box">
    <div class="help-modal-hd">
      <div>
        <h2>ğŸ“– í† ì§€ì •ë³´ ì¡°íšŒ ì‹œìŠ¤í…œ ì‚¬ìš©ì„¤ëª…ì„œ</h2>
        <p>VWorld API ê¸°ë°˜ ì§€ì ì •ë³´ Â· ìš©ë„ì§€ì—­ Â· í™˜ê²½ì„±í‰ê°€ ì¡°íšŒ ê°€ì´ë“œ</p>
      </div>
      <button class="help-modal-close" onclick="closeHelp()">âœ•</button>
    </div>
    <div class="help-modal-body">

      <!-- 1. ì‹œì‘í•˜ê¸° -->
      <div class="hm-sec">
        <div class="hm-sec-title">1. ì‹œì‘í•˜ê¸°</div>
        <div class="hm-row">
          <div class="hm-icon">ğŸ—º</div>
          <div class="hm-text">ì‚¬ì´íŠ¸ì— ì ‘ì†í•˜ë©´ <strong>2D ì§€ë„</strong>ì™€ í•¨ê»˜ <strong>ì§€ì ë„ ë ˆì´ì–´</strong>ê°€ ìë™ìœ¼ë¡œ í™œì„±í™”ë©ë‹ˆë‹¤. ì§€ë„ë¥¼ ì¶©ë¶„íˆ í™•ëŒ€í•˜ë©´ ì§€ì ì„ (í•„ì§€ ê²½ê³„)ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
        <div class="hm-row">
          <div class="hm-icon">ğŸ”</div>
          <div class="hm-text">ìš°ì¸¡ íŒ¨ë„ ìƒë‹¨ì˜ <strong>ì£¼ì†Œ ê²€ìƒ‰ì°½</strong>ì— ì£¼ì†Œë¥¼ ì…ë ¥í•˜ê³  ê²€ìƒ‰í•˜ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™í•©ë‹ˆë‹¤.<br>ì˜ˆ) <em>íŒêµë¡œ 242</em> &nbsp;/&nbsp; <em>ì„œìš¸ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 837</em></div>
        </div>
        <div class="hm-tip">ğŸ’¡ ì§€ì ì„ ì´ ë³´ì´ì§€ ì•Šìœ¼ë©´ ì§€ë„ë¥¼ ë” í™•ëŒ€í•´ ì£¼ì„¸ìš”. í™”ë©´ í•˜ë‹¨ì— <strong>"í™•ëŒ€í•´ì•¼ ì§€ì ì„ ì´ ë³´ì…ë‹ˆë‹¤"</strong> ì•ˆë‚´ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
      </div>

      <hr class="hm-divider"/>

      <!-- 2. ì§€ë„ ì¡°ì‘ -->
      <div class="hm-sec">
        <div class="hm-sec-title">2. ì§€ë„ ì¡°ì‘</div>
        <table class="hm-table">
          <tr><th>ë™ì‘</th><th>PC</th><th>ëª¨ë°”ì¼</th></tr>
          <tr><td>ì´ë™</td><td>ë§ˆìš°ìŠ¤ ë“œë˜ê·¸</td><td>ì†ê°€ë½ ë“œë˜ê·¸</td></tr>
          <tr><td>í™•ëŒ€/ì¶•ì†Œ</td><td>ë§ˆìš°ìŠ¤ íœ  ìŠ¤í¬ë¡¤</td><td>ë‘ ì†ê°€ë½ í•€ì¹˜</td></tr>
          <tr><td>í† ì§€ ì •ë³´ ì¡°íšŒ</td><td>ì§€ë„ ìœ„ í´ë¦­</td><td>ì§€ë„ ìœ„ íƒ­</td></tr>
        </table>
        <div class="hm-row" style="margin-top:10px;">
          <div class="hm-icon">ğŸŒ</div>
          <div class="hm-text">ì§€ë„ ì¢Œì¸¡ ìƒë‹¨ ë“œë¡­ë‹¤ìš´ì—ì„œ <strong>2D ì¼ë°˜ì§€ë„</strong>ì™€ <strong>3D ì§€ë„</strong>ë¥¼ ì „í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
      </div>

      <hr class="hm-divider"/>

      <!-- 3. í† ì§€ ì •ë³´ ì¡°íšŒ -->
      <div class="hm-sec">
        <div class="hm-sec-title">3. í† ì§€ ì •ë³´ ì¡°íšŒ</div>
        <div class="hm-row">
          <div class="hm-icon">ğŸ‘†</div>
          <div class="hm-text"><strong>ì§€ë„ì—ì„œ ì›í•˜ëŠ” í•„ì§€ë¥¼ í´ë¦­</strong>í•˜ë©´ í•´ë‹¹ í† ì§€ì˜ ìƒì„¸ ì •ë³´ê°€ ìš°ì¸¡ íŒ¨ë„ì— ì¹´ë“œ í˜•íƒœë¡œ ì¶”ê°€ë©ë‹ˆë‹¤.</div>
        </div>
        <div class="hm-row">
          <div class="hm-icon">ğŸ“‹</div>
          <div class="hm-text">ìˆ˜ì§‘ëœ ê° ì¹´ë“œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ì •ë³´:</div>
        </div>
        <table class="hm-table">
          <tr><th>í•­ëª©</th><th>ì„¤ëª…</th></tr>
          <tr><td>ì†Œì¬ì§€ / ì§€ë²ˆ</td><td>í–‰ì •ë™ëª…ê³¼ ì§€ë²ˆ ì£¼ì†Œ</td></tr>
          <tr><td>ì§€ëª©</td><td>í† ì§€ì˜ ì´ìš© ëª©ì  ë¶„ë¥˜ (ì „, ë‹µ, ëŒ€, ì„ì•¼ ë“±)</td></tr>
          <tr><td>ë©´ì </td><td>í•„ì§€ ë©´ì  (ã¡)</td></tr>
          <tr><td>ê³µì‹œì§€ê°€</td><td>ë‹¨ìœ„ë©´ì (ã¡)ë‹¹ ê³µì‹œì§€ê°€ (ì›)</td></tr>
          <tr><td>ìš©ë„ì§€ì—­</td><td>êµ­í† ê³„íšë²•ìƒ ìš©ë„ì§€ì—­</td></tr>
          <tr><td>ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­</td><td>ì§€êµ¬ë‹¨ìœ„ê³„íš êµ¬ì—­ ì—¬ë¶€ ë° ëª…ì¹­</td></tr>
          <tr><td>ì†Œìœ êµ¬ë¶„</td><td>êµ­ìœ ì§€ / ê³µìœ ì§€ / ì‚¬ìœ ì§€ ë“±</td></tr>
        </table>
        <div class="hm-row" style="margin-top:10px;">
          <div class="hm-icon">ğŸ”´</div>
          <div class="hm-text">í´ë¦­í•œ í•„ì§€ëŠ” ì§€ë„ ìœ„ì— <strong>ë¹¨ê°„ìƒ‰ í•˜ì´ë¼ì´íŠ¸</strong>ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
        <div class="hm-row">
          <div class="hm-icon">ğŸ—‘</div>
          <div class="hm-text">ì¹´ë“œ ìš°ì¸¡ ìƒë‹¨ì˜ <strong>ì‚­ì œ ë²„íŠ¼</strong>ìœ¼ë¡œ ê°œë³„ í•„ì§€ë¥¼ ëª©ë¡ì—ì„œ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
      </div>

      <hr class="hm-divider"/>

      <!-- 4. ì£¼ì œë„ -->
      <div class="hm-sec">
        <div class="hm-sec-title">4. ì£¼ì œë„ (ë ˆì´ì–´) í™œìš©</div>
        <div class="hm-row">
          <div class="hm-icon">ğŸ“‹</div>
          <div class="hm-text"><strong>êµ­í† ê³„íš ì£¼ì œë„</strong> íŒ¨ë„ì„ í¼ì¹˜ë©´ ì•„ë˜ ë ˆì´ì–´ë¥¼ ì§€ë„ì— ê²¹ì³ í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
        <table class="hm-table">
          <tr><th>ë ˆì´ì–´</th><th>ì„¤ëª…</th></tr>
          <tr><td>ì—°ì†ì§€ì ë„</td><td>í•„ì§€ ê²½ê³„ë¥¼ ìƒ‰ìƒë³„ë¡œ êµ¬ë¶„í•œ ì§€ì  ë ˆì´ì–´</td></tr>
          <tr><td>ë„ì‹œì§€ì—­ (ìš©ë„ì§€ì—­)</td><td>ì£¼ê±°Â·ìƒì—…Â·ê³µì—…Â·ë…¹ì§€ ë“± ìš©ë„ì§€ì—­ ìƒ‰ìƒ êµ¬ë¶„</td></tr>
          <tr><td>ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­</td><td>ì§€êµ¬ë‹¨ìœ„ê³„íšì´ ìˆ˜ë¦½ëœ êµ¬ì—­ í‘œì‹œ</td></tr>
        </table>
        <div class="hm-row" style="margin-top:10px;">
          <div class="hm-icon">ğŸŒ¿</div>
          <div class="hm-text"><strong>êµ­í† í™˜ê²½ì„±í‰ê°€ ì£¼ì œë„</strong>ëŠ” í† ì§€ì˜ í™˜ê²½ ë³´ì „ ë“±ê¸‰ì„ í‘œì‹œí•©ë‹ˆë‹¤.</div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 4px 34px;">
          <span class="hm-badge" style="background:#006633;">1ë“±ê¸‰ (ë³´ì „ ìµœìš°ì„ )</span>
          <span class="hm-badge" style="background:#339966;">2ë“±ê¸‰</span>
          <span class="hm-badge" style="background:#BBAA00;">3ë“±ê¸‰</span>
          <span class="hm-badge" style="background:#CC6600;">4ë“±ê¸‰</span>
          <span class="hm-badge" style="background:#CC3300;">5ë“±ê¸‰ (ê°œë°œ ê°€ëŠ¥)</span>
        </div>
        <div class="hm-tip">ğŸ’¡ ì²´í¬ë°•ìŠ¤ë¡œ ê° ë ˆì´ì–´ë¥¼ ì¼œê³  ëŒ ìˆ˜ ìˆìœ¼ë©°, ë“œë˜ê·¸ë¡œ ë ˆì´ì–´ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
      </div>

      <hr class="hm-divider"/>

      <!-- 5. ë°ì´í„° ìˆ˜ì§‘ ë° ë‚´ë³´ë‚´ê¸° -->
      <div class="hm-sec">
        <div class="hm-sec-title">5. ë°ì´í„° ìˆ˜ì§‘ ë° ë‚´ë³´ë‚´ê¸°</div>
        <div class="hm-row">
          <div class="hm-icon">ğŸ“</div>
          <div class="hm-text">ì—¬ëŸ¬ í•„ì§€ë¥¼ í´ë¦­í•´ ìˆ˜ì§‘í•˜ë©´ <strong>í•„ì§€ ìˆ˜ ë° ë©´ì  í•©ê³„</strong>ê°€ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</div>
        </div>
        <div class="hm-row">
          <div class="hm-icon">ğŸ’°</div>
          <div class="hm-text"><strong>ê³µì‹œì§€ê°€ ì´ì•¡</strong>ì„ ì› / ì²œì› / ë°±ë§Œì› / ì–µì› ë‹¨ìœ„ë¡œ ì „í™˜í•˜ì—¬ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
        <div class="hm-row">
          <div class="hm-icon">ğŸ”ƒ</div>
          <div class="hm-text">ëª©ë¡ ì •ë ¬: <strong>ìµœì‹ ìˆœ</strong> Â· <strong>ì§€ë²ˆ ì˜¤ë¦„ì°¨ìˆœ(â–²)</strong> Â· <strong>ì§€ë²ˆ ë‚´ë¦¼ì°¨ìˆœ(â–¼)</strong></div>
        </div>
        <table class="hm-table" style="margin-top:8px;">
          <tr><th>ë²„íŠ¼</th><th>ê¸°ëŠ¥</th></tr>
          <tr><td>ğŸ’¾ í† ì§€ì¡°ì„œ ë‚´ë³´ë‚´ê¸°</td><td>ìˆ˜ì§‘ëœ í•„ì§€ ì •ë³´ë¥¼ <strong>CSV íŒŒì¼</strong>ë¡œ ì €ì¥ (ì—‘ì…€ í˜¸í™˜)</td></tr>
          <tr><td>ğŸ“‹ í† ì§€ëª©ë¡ë³´ê¸°</td><td>ìˆ˜ì§‘ ëª©ë¡ì„ <strong>ë³„ë„ ì°½</strong>ì—ì„œ í‘œ í˜•íƒœë¡œ í™•ì¸</td></tr>
          <tr><td>ğŸ—‘ ì „ì²´ ì‚­ì œ</td><td>ìˆ˜ì§‘ëœ ëª¨ë“  í•„ì§€ ì •ë³´ ë° í•˜ì´ë¼ì´íŠ¸ ì´ˆê¸°í™”</td></tr>
        </table>
      </div>

      <hr class="hm-divider"/>

      <!-- 6. ëª¨ë°”ì¼ ì‚¬ìš©ë²• -->
      <div class="hm-sec">
        <div class="hm-sec-title">6. ëª¨ë°”ì¼ ì‚¬ìš©ë²•</div>
        <div class="hm-row">
          <div class="hm-icon">ğŸ“±</div>
          <div class="hm-text">ëª¨ë°”ì¼ì—ì„œëŠ” í™”ë©´ ìƒë‹¨ <strong>55%ê°€ ì§€ë„</strong>, í•˜ë‹¨ <strong>45%ê°€ ì •ë³´ íŒ¨ë„</strong>ë¡œ ë¶„ë¦¬ë©ë‹ˆë‹¤.</div>
        </div>
        <div class="hm-row">
          <div class="hm-icon">â˜°</div>
          <div class="hm-text">í•˜ë‹¨ íŒ¨ë„ ìƒë‹¨ì˜ <strong>í•¸ë“¤ ë°”ë¥¼ íƒ­</strong>í•˜ë©´ íŒ¨ë„ì„ ì ‘ê±°ë‚˜ í¼ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
        <div class="hm-row">
          <div class="hm-icon">â†”</div>
          <div class="hm-text">ëª¨ë°”ì¼ì—ì„œëŠ” ìˆ˜ì§‘ëœ í† ì§€ ëª©ë¡ì´ <strong>ê°€ë¡œ ìŠ¤í¬ë¡¤ í…Œì´ë¸”</strong> í˜•íƒœë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
        <div class="hm-tip">ğŸ’¡ ëª¨ë°”ì¼ì—ì„œ ì§€ë„ë¥¼ ì¡°ì‘í•  ë•Œ íŒ¨ë„ì´ ë°©í•´ëœë‹¤ë©´ í•¸ë“¤ì„ íƒ­í•˜ì—¬ íŒ¨ë„ì„ ì ‘ì–´ë‘ì„¸ìš”.</div>
      </div>

      <hr class="hm-divider"/>

      <!-- 7. ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ -->
      <div class="hm-sec">
        <div class="hm-sec-title">7. ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ (FAQ)</div>
        <div class="hm-row">
          <div class="hm-icon">â“</div>
          <div class="hm-text"><strong>ì§€ë„ë¥¼ í´ë¦­í•´ë„ ì •ë³´ê°€ ì•ˆ ë‚˜ì™€ìš”.</strong><br>ì§€ë„ë¥¼ ì¶©ë¶„íˆ í™•ëŒ€í•˜ì—¬ ì§€ì ì„ ì´ ë³´ì´ëŠ” ìƒíƒœì—ì„œ í•„ì§€ ìœ„ë¥¼ ì •í™•íˆ í´ë¦­í•´ ì£¼ì„¸ìš”.</div>
        </div>
        <div class="hm-row">
          <div class="hm-icon">â“</div>
          <div class="hm-text"><strong>ê°™ì€ í•„ì§€ë¥¼ ë‘ ë²ˆ í´ë¦­í•˜ë©´?</strong><br>"ì´ë¯¸ ì¶”ê°€ëœ í•„ì§€ì…ë‹ˆë‹¤" ë©”ì‹œì§€ê°€ í‘œì‹œë˜ë©° ì¤‘ë³µ ì¶”ê°€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
        </div>
        <div class="hm-row">
          <div class="hm-icon">â“</div>
          <div class="hm-text"><strong>ì£¼ì†Œ ê²€ìƒ‰ì´ ì•ˆ ë  ë•ŒëŠ”?</strong><br>ë„ë¡œëª… ì£¼ì†Œ ë˜ëŠ” ì§€ë²ˆ ì£¼ì†Œë¡œ ê²€ìƒ‰í•´ ë³´ì„¸ìš”. ë„ˆë¬´ ê´‘ë²”ìœ„í•œ ê²€ìƒ‰ì–´ë³´ë‹¤ êµ¬ì²´ì ì¸ ì£¼ì†Œê°€ ì •í™•í•©ë‹ˆë‹¤.</div>
        </div>
        <div class="hm-row">
          <div class="hm-icon">â“</div>
          <div class="hm-text"><strong>ì£¼ì œë„ ë ˆì´ì–´ê°€ ë³´ì´ì§€ ì•Šì•„ìš”.</strong><br>ì²´í¬ë°•ìŠ¤ë¥¼ ì²´í¬í•œ ë’¤ ì§€ë„ë¥¼ ì ì ˆíˆ í™•ëŒ€í•˜ë©´ ë ˆì´ì–´ê°€ í‘œì‹œë©ë‹ˆë‹¤. ì¼ë¶€ ë ˆì´ì–´ëŠ” íŠ¹ì • ì¤Œ ë ˆë²¨ ì´ìƒì—ì„œë§Œ ë³´ì…ë‹ˆë‹¤.</div>
        </div>
      </div>

    </div><!-- /.help-modal-body -->
  </div><!-- /.help-modal-box -->
</div><!-- /#helpModal -->

<script>
/* ===================================================
   ì „ì—­ ë³€ìˆ˜
=================================================== */
var apiKey = "A12CEDAE-86F1-3453-BC92-3FD98BE14103";
var ecvamApiKey = "MUTW-PGHX-76CT-ENMD";
var ECVAM_WMS = "https://ecvam.neins.go.kr/apicall.do";
var map2d, map3d, markerLayer;
var currentMapType = "2d";
var isLandParcelActive = false;
var landLayer2d = null, landLayer3d = null;
var map3dClickAdded = false;
var collectedLandInfo = [];
var markers = [];
var themeLayers = {};
var ecvamThemeLayers = {};
var cache = {};
var highlightLayer = null;
var highlight3dEntities = {};
var selectedFeatures = {};
var jigaUnit = 'ì›'; // ê³µì‹œì§€ê°€ í‘œì‹œ ë‹¨ìœ„: 'ì›' | 'ì²œì›' | 'ë°±ë§Œì›' | 'ì–µì›'
var hoverTimer = null;
var hoverCache = {};
var sortMode = 'newest'; // 'newest' | 'jibun_asc' | 'jibun_desc'
var CADASTRAL_MIN_ZOOM = 17; // ì§€ì ë„ ê°€ì‹œ ìµœì†Œ ì¤Œ ë ˆë²¨ (VWorld LP_PA_CBND_BUBUN ê¸°ì¤€)

/* HTML íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ (XSS ë°©ì§€) */
function escHtml(s) {
  if (s === null || s === undefined) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
/* onclick ì†ì„± ë‚´ ë¬¸ìì—´ ì´ìŠ¤ì¼€ì´í”„ */
function escAttr(s) {
  if (s === null || s === undefined) return '';
  return String(s).replace(/[^a-zA-Z0-9\-_]/g, '');
}

/* ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ í•­ëª©ì—ì„œ ë ˆì´ë¸”(ë¬¸ìì—´) ì¶”ì¶œ â€” [object Object] ë°©ì§€ */
function extractLabel(item, fallback) {
  var a = item.address;
  var addrStr = (typeof a === 'object' && a !== null)
    ? (a.road || a.parcel || '')
    : (a || '');
  return item.title || addrStr || fallback || '';
}

/* ì§€ë²ˆ ìì—° ì •ë ¬ ë¹„êµ (ì‚° ì ‘ë‘ì‚¬ ì²˜ë¦¬, ë³¸ë²ˆ-ë¶€ë²ˆ ìˆ«ì ë¹„êµ) */
function naturalCmp(a, b) {
  var aSan = /^ì‚°/.test(String(a)) ? 1 : 0, bSan = /^ì‚°/.test(String(b)) ? 1 : 0;
  if (aSan !== bSan) return aSan - bSan;
  var ap = String(a).replace(/^ì‚°\s*/, '').split('-');
  var bp = String(b).replace(/^ì‚°\s*/, '').split('-');
  var am = parseInt(ap[0]) || 0, bm = parseInt(bp[0]) || 0;
  if (am !== bm) return am - bm;
  return (parseInt(ap[1]) || 0) - (parseInt(bp[1]) || 0);
}

/* ì •ë ¬ ëª¨ë“œ ë³€ê²½ */
function setSortMode(mode) {
  sortMode = mode;
  $('.sort-btn').removeClass('active');
  var ids = { newest: 'sortNewest', jibun_asc: 'sortJibunAsc', jibun_desc: 'sortJibunDesc' };
  $('#' + ids[mode]).addClass('active');
  sortLandList();
}

/* ì¹´ë“œ ëª©ë¡ + ëª¨ë°”ì¼ í…Œì´ë¸” ì¬ì •ë ¬ */
function sortLandList() {
  if (collectedLandInfo.length === 0) return;
  var sorted = collectedLandInfo.slice();
  if (sortMode === 'jibun_asc') {
    sorted.sort(function(a, b) { return naturalCmp(a.jibun || '', b.jibun || ''); });
  } else if (sortMode === 'jibun_desc') {
    sorted.sort(function(a, b) { return naturalCmp(b.jibun || '', a.jibun || ''); });
  } else {
    sorted.reverse(); // ìµœì‹ ìˆœ = ë§ˆì§€ë§‰ ì¶”ê°€ê°€ ë§¨ ìœ„
  }
  // ë°ìŠ¤í¬íƒ‘ ì¹´ë“œ ì¬ë°°ì¹˜
  sorted.forEach(function(d) {
    var $card = $('.land-item[data-pnu="' + d.pnu + '"]');
    if ($card.length) $('#landList').append($card);
  });
  // ëª¨ë°”ì¼ í…Œì´ë¸” í–‰ ì¬ë°°ì¹˜ + ë²ˆí˜¸ ê°±ì‹ 
  sorted.forEach(function(d, i) {
    var $row = $('#mobLandTbody tr[data-pnu="' + d.pnu + '"]');
    if ($row.length) { $row.find('td:first').text(i + 1); $('#mobLandTbody').append($row); }
  });
}

/* ê³µì‹œì§€ê°€ ê¸ˆì•¡ì„ í˜„ì¬ ë‹¨ìœ„ë¡œ í¬ë§· (ì†Œìˆ˜ì  2ìë¦¬) */
function formatJiga(rawAmount) {
  if (!rawAmount || rawAmount <= 0) return '-';
  if (jigaUnit === 'ì–µì›')  return (rawAmount / 100000000).toFixed(2) + ' ì–µì›';
  if (jigaUnit === 'ë°±ë§Œì›') return (rawAmount / 1000000).toFixed(2) + ' ë°±ë§Œì›';
  if (jigaUnit === 'ì²œì›')  return (rawAmount / 1000).toFixed(2) + ' ì²œì›';
  return Math.round(rawAmount).toLocaleString('ko-KR') + ' ì›';
}

/* ë‹¨ìœ„ ë³€ê²½ ì‹œ í™”ë©´ ì „ì²´ ê°±ì‹  */
function changeJigaUnit(unit) {
  jigaUnit = unit;
  // ìš”ì•½ ë°” ì´ì•¡ ê°±ì‹ 
  var totalJiga = 0;
  collectedLandInfo.forEach(function(d) {
    var a = parseFloat(d.area_ || d.parea || 0);
    var j = parseFloat(String(d.jiga || '0').replace(/,/g, ''));
    if (!isNaN(a) && !isNaN(j) && j > 0) totalJiga += (a * j);
  });
  if (totalJiga > 0) $("#jigaSumVal").text(formatJiga(Math.round(totalJiga)));
  // ê° ì¹´ë“œ í† ì§€ ê³µì‹œì§€ê°€ ì´ì•¡ ê°±ì‹ 
  $('.jiga-total-val').each(function() {
    var raw = parseFloat($(this).data('jiga-raw'));
    $(this).text(raw > 0 ? formatJiga(raw) : '-');
  });
}

/* (ì‚°ì§€êµ¬ë¶„ ì½”ë“œ ì œê±°ë¨) */

var themeData = [
  { name:"ì—°ì†ì§€ì ë„",        layer:"LP_PA_CBND_BUBUN",    lf:"jibun" },
  { name:"ë„ì‹œì§€ì—­(ìš©ë„ì§€ì—­)", layer:"LT_C_UQ111",          lf:"uname" },
  { name:"ê´€ë¦¬ì§€ì—­(ìš©ë„ì§€ì—­)", layer:"LT_C_UQ112",          lf:"uname" },
  { name:"ë†ë¦¼ì§€ì—­(ìš©ë„ì§€ì—­)", layer:"LT_C_UQ113",          lf:"uname" },
  { name:"ìì—°í™˜ê²½ë³´ì „ì§€ì—­",   layer:"LT_C_UQ114",          lf:"uname" },
  { name:"ê°œë°œì œí•œêµ¬ì—­",       layer:"LT_C_UD801",          lf:"" },
  { name:"ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­",   layer:"LT_C_UPISUQ161",      lf:"dgm_nm" },
  { name:"ë„ì‹œê³„íš ë„ë¡œ",      layer:"LT_C_UPISUQ151",      lf:"" },
  { name:"ë„ì‹œê³„íš ê³µê°„ì‹œì„¤",  layer:"LT_C_UPISUQ153",      lf:"" },
  { name:"ë„ì‹œê³„íš ìœ í†µê³µê¸‰",  layer:"LT_C_UPISUQ154",      lf:"" },
  { name:"ê³µê³µë¬¸í™”ì²´ìœ¡ì‹œì„¤",   layer:"LT_C_UPISUQ155",      lf:"" },
  { name:"ë„ì‹œê³„íš ë°©ì¬ì‹œì„¤",  layer:"LT_C_UPISUQ156",      lf:"" },
  { name:"ë„ì‹œê³„íš ë³´ê±´ìœ„ìƒ",  layer:"LT_C_UPISUQ157",      lf:"" },
  { name:"ë„ì‹œê³„íš í™˜ê²½ìœ„ìƒ",  layer:"LT_C_UPISUQ158",      lf:"" },
  { name:"ë„ì‹œê³„íš ê¸°íƒ€ê¸°ë°˜",  layer:"LT_C_UPISUQ159",      lf:"" },
  { name:"ìƒìˆ˜ì›ë³´í˜¸êµ¬ì—­",     layer:"LT_C_UM710",          lf:"uname" },
  { name:"ê±´ì¶•ë¬¼ ì •ë³´",        layer:"LT_C_BLDGINFO",       lf:"" },
  { name:"ì´ˆë“±í•™êµí†µí•™êµ¬ì—­",   layer:"LT_C_DESCH",          lf:"hakgudo_nm" },
  { name:"ì‚°ë¦¼ì…ì§€ë„(ì‚°ì§€)",   layer:"LT_C_FSDIFRSTS",      lf:"name" }  /* ì°¸ê³ ìš© ì£¼ì œë„ë§Œ ìœ ì§€ */
];

/* ECVAM í™˜ê²½ì„±í‰ê°€ ë ˆì´ì–´ ëª©ë¡ (ecvam.neins.go.kr) */
var ecvamThemeData = [
  { id:"nem_ecvam",    name:"êµ­í† í™˜ê²½ì„±í‰ê°€ì§€ë„ (ì¢…í•©ë“±ê¸‰)" },
  { id:"nem_eco",      name:"í™˜ê²½Â·ìƒíƒœì  í‰ê°€ê²°ê³¼" },
  { id:"nem_eco_01",   name:"ìƒíƒœìì—°ë„(ë‹¤ì–‘ì„±)" },
  { id:"nem_eco_02",   name:"ìì—°ì„± í‰ê°€" },
  { id:"nem_eco_04",   name:"í¬ê·€ì„± í‰ê°€" },
  { id:"nem_law",      name:"ë²•ì œì  í‰ê°€ê²°ê³¼ (ì¢…í•©)" },
  { id:"nem_law_01",   name:"ìƒíƒœÂ·ê²½ê´€ë³´ì „ì§€ì—­" },
  { id:"nem_law_28",   name:"ìì—°í™˜ê²½ë³´ì „ì§€ì—­" },
  { id:"nem_law_22",   name:"ìƒìˆ˜ì›ë³´í˜¸êµ¬ì—­" },
  { id:"nem_law_35",   name:"ê°œë°œì œí•œêµ¬ì—­" }
];

/* ===================================================
   ì´ˆê¸°í™”
=================================================== */
$(document).ready(function() {
  init2dMap();
  init3dMap();
  setupEvents();
  initThemeList();
  initEcvamThemeList();

  $("#vmap").hide();
  $("#ol3map").show();

  // ê¸°ë³¸ ìœ„ì¹˜: ê²½ê¸°ë„ ê´‘ì£¼ì‹œ íƒœì „ë™ 744ë²ˆì§€
  activateLandParcel();

  // ì‚¬ìš©ì í˜„ì¬ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(pos) {
        var lon = pos.coords.longitude;
        var lat = pos.coords.latitude;
        try {
          map2d.getView().setCenter(ol.proj.fromLonLat([lon, lat]));
          map2d.getView().setZoom(18);
          try {
            map3d.moveTo(new vw.CameraPosition(
              new vw.CoordZ(lon, lat, 500),
              new vw.Direction(0, -90, 0)
            ));
          } catch(e3){}
        } catch(e){}
        showMsg("ğŸ“ í˜„ì¬ ìœ„ì¹˜ë¡œ ì§€ë„ë¥¼ ì´ë™í–ˆìŠµë‹ˆë‹¤.", "ok");
      },
      function() { /* ìœ„ì¹˜ ê±°ë¶€ ë˜ëŠ” ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ìœ„ì¹˜ ìœ ì§€ */ },
      { timeout: 8000, maximumAge: 60000 }
    );
  }

  initHoverTooltip();

  function activateLandParcel() {
    $("#landChk").prop("checked", true);
    toggleLandParcel(true);
    try { map2d.updateSize(); } catch(e){}
  }

  $(window).on('resize', function(){
    if (currentMapType === "2d") try{ map2d.updateSize(); }catch(e){}
  });

});

/* ===================================================
   2D ì§€ë„ ì´ˆê¸°í™”
=================================================== */
function init2dMap() {
  vw.ol3.MapOptions = {
    basemapType: vw.ol3.BasemapType.GRAPHIC,
    controlDensity: vw.ol3.DensityType.EMPTY,
    interactionDensity: vw.ol3.DensityType.BASIC,
    controlsAutoArrange: true,
    homePosition: vw.ol3.CameraPosition,
    initPosition: vw.ol3.CameraPosition
  };
  map2d = new vw.ol3.Map("ol3map", vw.ol3.MapOptions);
  map2d.getView().setCenter(ol.proj.fromLonLat([127.23601, 37.38138]));
  map2d.getView().setZoom(18);

  highlightLayer = new ol.layer.Vector({
    source: new ol.source.Vector(),
    style: new ol.style.Style({
      stroke: new ol.style.Stroke({ color:'#ff2222', width:3 }),
      fill: new ol.style.Fill({ color:'rgba(255,30,30,0.12)' })
    }),
    zIndex: 500
  });
  map2d.addLayer(highlightLayer);
  markerLayer = new vw.ol3.layer.Marker(map2d, { showTitle:true });
  map2d.addLayer(markerLayer);
  map2d.on('singleclick', debounce(handleMap2dClick, 250));
  map2d.on('moveend', checkCadastralZoom);
}

/* ì§€ì ë„ ê°€ì‹œ ì¤Œ ì²´í¬ â†’ ê²½ê³  ë°°ë„ˆ í‘œì‹œ/ìˆ¨ê¹€ */
function checkCadastralZoom() {
  if (currentMapType !== '2d' || !isLandParcelActive) {
    $('#zoomWarn').hide();
    return;
  }
  try {
    var z = map2d.getView().getZoom();
    if (z < CADASTRAL_MIN_ZOOM) $('#zoomWarn').show();
    else $('#zoomWarn').hide();
  } catch(e) {}
}

/* ===================================================
   3D ì§€ë„ ì´ˆê¸°í™”
=================================================== */
function init3dMap() {
  var opts = {
    mapId: "vmap",
    initPosition: new vw.CameraPosition(
      new vw.CoordZ(127.23601, 37.38138, 500),
      new vw.Direction(0, -90, 0)
    ),
    logo: false, navigation: false
  };
  map3d = new vw.Map();
  map3d.setOption(opts);
  map3d.setMapId("vmap");
  map3d.setInitPosition(opts.initPosition);
  map3d.setLogoVisible(false);
  map3d.setNavigationZoomVisible(true);
  map3d.start();
}

/* ===================================================
   ì§€ë„ íƒ€ì… ì „í™˜ (ìœ„ì¹˜ ë™ê¸°í™” í¬í•¨)
=================================================== */
function changeMapType() {
  currentMapType = $("#mapTypeSel").val();

  if (currentMapType === "3d") {
    // 2D â†’ 3D: í˜„ì¬ 2D ìœ„ì¹˜ë¥¼ 3Dì— ë™ê¸°í™”
    var lon2d, lat2d, zoom2d;
    try {
      var c = ol.proj.toLonLat(map2d.getView().getCenter());
      lon2d = c[0]; lat2d = c[1];
      zoom2d = map2d.getView().getZoom() || 18;
    } catch(e){}

    $("#ol3map").hide(); $("#vmap").show();
    $("#currentMapType").text("3D ì§€ë„");
    $("#bldRow").show();
    if (isLandParcelActive) { isLandParcelActive = false; toggle3dLayer(true); }

    // 3D ìœ„ì¹˜ ì´ë™ (ì¤Œë ˆë²¨ â†’ ê³ ë„ ë³€í™˜: zoom18 â‰ˆ 500m)
    if (lon2d && lat2d) {
      var alt = Math.max(150, Math.pow(2, 20 - zoom2d) * 125);
      setTimeout(function(){
        try {
          map3d.moveTo(new vw.CameraPosition(
            new vw.CoordZ(lon2d, lat2d, alt),
            new vw.Direction(0, -90, 0)
          ));
        } catch(e){}
        // ìˆ˜ì§‘ í•„ì§€ 3D í•˜ì´ë¼ì´íŠ¸ ë³µì›
        collectedLandInfo.forEach(function(d) {
          if (d._geometry && !highlight3dEntities[d.pnu]) {
            addHighlight3d(d._geometry, d.pnu);
          }
        });
      }, 500);
    }
    try{ map3d.refresh(); }catch(e){}

  } else {
    // 3D â†’ 2D: í˜„ì¬ 3D ìœ„ì¹˜ë¥¼ 2Dì— ë™ê¸°í™”
    var lon3d, lat3d, z3d;
    try {
      var pos = map3d.getCurrentPosition().position;
      lon3d = pos.lon || pos.x || pos[0];
      lat3d = pos.lat || pos.y || pos[1];
      z3d = pos.z || pos.alt || pos[2];
    } catch(e){}

    $("#vmap").hide(); $("#ol3map").show();
    $("#currentMapType").text("2D ì¼ë°˜ì§€ë„");
    $("#bldRow").hide();
    if (isLandParcelActive) { isLandParcelActive = false; toggle2dLayer(true); }

    if (lon3d && lat3d) {
      var zoom2dNew = z3d ? Math.max(CADASTRAL_MIN_ZOOM, Math.min(20, Math.round(20 - Math.log2(z3d / 125)))) : 18;
      try {
        map2d.getView().setCenter(ol.proj.fromLonLat([lon3d, lat3d]));
        map2d.getView().setZoom(zoom2dNew);
      } catch(e){}
    }
    // 3D í•˜ì´ë¼ì´íŠ¸ ì œê±° (2D í•˜ì´ë¼ì´íŠ¸ëŠ” highlightLayerì— ê·¸ëŒ€ë¡œ ìœ ì§€ë¨)
    Object.keys(highlight3dEntities).forEach(function(pnu){ removeHighlight3d(pnu); });
    try{ map2d.updateSize(); }catch(e){}
    checkCadastralZoom();
  }
}

/* ===================================================
   ê±´ë¬¼ ë ˆì´ì–´ í† ê¸€ (3D ì „ìš©)
=================================================== */
function checkLayer(c, name) {
  if (currentMapType !== "3d") return;
  try {
    if ($(c).is(":checked")) map3d.getLayerElement(name).show();
    else map3d.getLayerElement(name).hide();
  } catch(e){}
}

/* ===================================================
   ì§€ì ë„ í† ê¸€
=================================================== */
function toggleLandParcel(enable) {
  if (currentMapType === "3d") toggle3dLayer(enable);
  else toggle2dLayer(enable);
}

function toggle2dLayer(enable) {
  if (enable && !isLandParcelActive) {
    try {
      landLayer2d = map2d.addNamedLayer('LP_PA_CBND_BUBUN', 'LP_PA_CBND_BUBUN');
      map2d.addLayer(landLayer2d);
      isLandParcelActive = true;
      showMsg("2D ì§€ì ë„ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.", "ok");
      checkCadastralZoom();
    } catch(e){ showMsg("ì§€ì ë„ í™œì„±í™” ì˜¤ë¥˜: " + e.message, "err"); }
  } else if (!enable && isLandParcelActive) {
    try {
      if (landLayer2d) { landLayer2d.setVisible(false); map2d.removeLayer(landLayer2d); landLayer2d = null; }
      isLandParcelActive = false;
      showMsg("ì§€ì ë„ê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
      $('#zoomWarn').hide();
    } catch(e){}
  }
}

function toggle3dLayer(enable) {
  if (enable && !isLandParcelActive) {
    try {
      // VWorld 3D ê³µì‹ API íŒ¨í„´ (V-world GitHub ìƒ˜í”Œ ê¸°ë°˜)
      // setStyles/setFormat ë¶ˆí•„ìš” â€” setUrl/setLayers/setParams ë§Œ ì‚¬ìš©
      var wmsSource = new vw.source.TileWMS();
      wmsSource.setUrl("https://api.vworld.kr/req/wms?Key=" + apiKey + "&");
      wmsSource.setLayers("lt_c_landinfobasemap");
      wmsSource.setParams("tilesize=256");

      var wmsTile = new vw.layer.Tile(wmsSource);
      landLayer3d = new vw.Layers();
      landLayer3d.add(wmsTile);

      if (!map3dClickAdded) {
        map3d.onClick.addEventListener(handleMap3dClick);
        map3dClickAdded = true;
      }
      isLandParcelActive = true;
      showMsg("3D ì§€ì ë„ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.", "ok");
    } catch(e){ showMsg("3D ì§€ì ë„ ì˜¤ë¥˜: " + e.message, "err"); }
  } else if (!enable && isLandParcelActive) {
    try {
      if (landLayer3d) { landLayer3d.removeAll(); landLayer3d = null; }
      try { map3d.onClick.removeEventListener(handleMap3dClick); } catch(e2){}
      map3dClickAdded = false;
      isLandParcelActive = false;
      showMsg("ì§€ì ë„ê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch(e){}
  }
}

/* ===================================================
   ì£¼ì œë„
=================================================== */
function initThemeList() {
  var $list = $("#themeList");
  themeData.forEach(function(t) {
    var $item = $('<div class="theme-item" data-layer="' + t.layer + '">' +
      '<span class="drag-handle">â˜°</span>' +
      '<input type="checkbox" id="tc_' + t.layer + '" data-layer="' + t.layer + '">' +
      '<label for="tc_' + t.layer + '">' + t.name + '</label>' +
      '</div>');
    $list.append($item);
    $item.find('input').on('change', function(){ toggleThemeLayer(t.layer, this.checked, t); });
  });
  try {
    $list.sortable({ handle:'.drag-handle', update: updateLayerOrder });
    $list.disableSelection();
  } catch(e){}
}

function toggleThemePanel() {
  var $list = $("#themeList");
  var $btn = $(".toggle-btn");
  if ($list.is(":visible")) { $list.slideUp(); $btn.text("í¼ì¹˜ê¸°"); }
  else { $list.slideDown(); $btn.text("ì ‘ê¸°"); }
}

function toggleThemeLayer(layerName, enable, theme) {
  if (currentMapType !== "2d") {
    showMsg("ì£¼ì œë„ëŠ” 2D ì§€ë„ì—ì„œë§Œ ì§€ì›í•©ë‹ˆë‹¤.", "err");
    $("#tc_" + layerName).prop("checked", false);
    return;
  }
  if (enable) {
    if (!themeLayers[layerName]) {
      try {
        themeLayers[layerName] = map2d.addNamedLayer(layerName, layerName);
        map2d.addLayer(themeLayers[layerName]);
      } catch(e){ showMsg("ë ˆì´ì–´ ì¶”ê°€ ì˜¤ë¥˜: " + e.message, "err"); return; }
    }
    themeLayers[layerName].setVisible(true);
    showMsg(theme.name + " ì£¼ì œë„ í™œì„±í™”ë¨.", "ok");
    updateLayerOrder();
  } else {
    if (themeLayers[layerName]) {
      themeLayers[layerName].setVisible(false);
      showMsg(theme.name + " ì£¼ì œë„ ë¹„í™œì„±í™”ë¨.");
    }
  }
}

function updateLayerOrder() {
  if (currentMapType !== "2d") return;
  $("#themeList .theme-item").each(function(i) {
    var ln = $(this).data("layer");
    if (themeLayers[ln]) try{ themeLayers[ln].setZIndex(100 - i); }catch(e){}
  });
}

/* ===================================================
   ECVAM í™˜ê²½ì„±í‰ê°€ ì£¼ì œë„
=================================================== */
function initEcvamThemeList() {
  var $list = $("#ecvamThemeList");
  ecvamThemeData.forEach(function(t) {
    var $item = $('<div class="theme-item" data-ecvam="' + t.id + '">' +
      '<span class="drag-handle">â˜°</span>' +
      '<input type="checkbox" id="etc_' + t.id + '" data-ecvam="' + t.id + '">' +
      '<label for="etc_' + t.id + '">' + t.name + '</label>' +
      '</div>');
    $list.append($item);
    $item.find('input').on('change', function(){ toggleEcvamLayer(t.id, t.name, this.checked); });
  });
}

function toggleEcvamPanel() {
  var $list = $("#ecvamThemeList");
  var $btn = $("#ecvamToggleBtn");
  if ($list.is(":visible")) { $list.slideUp(); $btn.text("í¼ì¹˜ê¸°"); }
  else { $list.slideDown(); $btn.text("ì ‘ê¸°"); }
}

function toggleEcvamLayer(layerId, layerName, enable) {
  if (currentMapType !== "2d") {
    showMsg("í™˜ê²½ì„±í‰ê°€ ì£¼ì œë„ëŠ” 2D ì§€ë„ì—ì„œë§Œ ì§€ì›í•©ë‹ˆë‹¤.", "err");
    $("#etc_" + layerId).prop("checked", false);
    return;
  }
  if (typeof ecvamLayerCreate === 'undefined') {
    showMsg("ECVAM API ë¡œë“œ ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²° í›„ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.", "err");
    $("#etc_" + layerId).prop("checked", false);
    return;
  }
  if (enable) {
    if (!ecvamThemeLayers[layerId]) {
      try {
        var layer = ecvamLayerCreate(layerId, true);
        layer.setZIndex(200);
        map2d.addLayer(layer);
        ecvamThemeLayers[layerId] = layer;
      } catch(e) { showMsg("ë ˆì´ì–´ ì¶”ê°€ ì˜¤ë¥˜: " + e.message, "err"); return; }
    } else {
      ecvamThemeLayers[layerId].setVisible(true);
    }
    showMsg("ğŸŒ¿ " + layerName + " ë ˆì´ì–´ í™œì„±í™”ë¨.", "ok");
  } else {
    if (ecvamThemeLayers[layerId]) {
      ecvamThemeLayers[layerId].setVisible(false);
      showMsg(layerName + " ë ˆì´ì–´ ë¹„í™œì„±í™”ë¨.");
    }
  }
}

/* ECVAM WMS GetFeatureInfo ë“±ê¸‰ ì¡°íšŒ
 * - CORS í—ˆìš© í™˜ê²½ì—ì„œëŠ” ì‹¤ì œ ë“±ê¸‰ ë°˜í™˜
 * - ë¡œì»¬/CORS ì°¨ë‹¨ í™˜ê²½ì—ì„œëŠ” '-' ë°˜í™˜ (ë¹„ì£¼ì–¼ ë ˆì´ì–´ë¡œ í™•ì¸) */
function fetchEcvamGrade(lon, lat, callback) {
  var delta = 0.0002;
  var bbox = (lon - delta) + ',' + (lat - delta) + ',' + (lon + delta) + ',' + (lat + delta);
  var baseParams = '&SERVICE=WMS&VERSION=1.1.0&REQUEST=GetFeatureInfo' +
    '&STYLES=&SRS=EPSG:4326&BBOX=' + bbox +
    '&WIDTH=10&HEIGHT=10&X=5&Y=5&FEATURE_COUNT=1';

  var result = { ecvam_gr: '-', bio_gr: '-' };
  var done = 0;

  function checkDone() { if (++done >= 2) callback(result); }

  function tryGfi(layerId, field, onDone) {
    $.ajax({
      url: ECVAM_WMS + '?LAYERS=' + layerId + '&QUERY_LAYERS=' + layerId +
           '&INFO_FORMAT=application/json' + baseParams,
      timeout: 4000,
      success: function(data) {
        try {
          var feats = (data && data.features) || [];
          if (feats.length > 0) {
            var p = feats[0].properties || {};
            /* ê°€ëŠ¥í•œ ì†ì„±ëª… ìˆœì„œëŒ€ë¡œ ì‹œë„ */
            var v = p.grade || p.GRADE || p.pvalue || p.value || p.ecvam_gr ||
                    p.score || p.SCORE || p.bio_gr || null;
            if (v !== null && v !== undefined) onDone(String(v));
            else onDone('-');
          } else { onDone('-'); }
        } catch(e) { onDone('-'); }
      },
      error: function() { onDone('-'); }
    });
  }

  /* êµ­í† í™˜ê²½ì„±í‰ê°€ë“±ê¸‰ */
  tryGfi('nem_ecvam', 'grade', function(v) {
    result.ecvam_gr = v;
    checkDone();
  });

  /* ìƒíƒœìì—°ë„ (nem_eco_01: ë‹¤ì–‘ì„± â€” ìƒíƒœìì—°ë„ ê¸°ë°˜ í•­ëª©) */
  tryGfi('nem_eco_01', 'grade', function(v) {
    result.bio_gr = v;
    checkDone();
  });
}

/* ECVAM ë“±ê¸‰ ë°°ì§€ HTML */
function ecvamGrBadge(gr) {
  if (!gr || gr === '-' || gr === 'null') {
    return '<span style="color:#aaa;font-size:11px;">-</span>';
  }
  var cls = 'ecvam-gr' + gr;
  return '<span class="ecvam-badge ' + cls + '">' + gr + 'ë“±ê¸‰</span>';
}

/* ê¸°ì¡´ ì¹´ë“œì˜ ECVAM ë“±ê¸‰ ì—…ë°ì´íŠ¸ (ë¹„ë™ê¸° ì¡°íšŒ í›„) */
function updateEcvamGradeOnCard(pnu, ecvamResult) {
  var $card = $('.land-item[data-pnu="' + pnu + '"]');
  if (!$card.length) return;
  $card.find('.ecvam-val-ecvam').html(ecvamGrBadge(ecvamResult.ecvam_gr));
  $card.find('.ecvam-val-bio').html(ecvamGrBadge(ecvamResult.bio_gr));
  /* collectedLandInfo ì—…ë°ì´íŠ¸ */
  var d = collectedLandInfo.find(function(x){ return x.pnu === pnu; });
  if (d) { d.ecvam_gr = ecvamResult.ecvam_gr; d.bio_gr = ecvamResult.bio_gr; }
}

/* ===================================================
   í´ë¦­ í•¸ë“¤ëŸ¬
=================================================== */
function handleMap2dClick(evt) {
  if (!isLandParcelActive) return;
  var ll = ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326');
  fetchLandInfo(ll[0], ll[1]);
}

function handleMap3dClick(wp, ep, carto) {
  if (!isLandParcelActive) return;
  if (carto && carto.longitudeDD && carto.latitudeDD) {
    fetchLandInfo(carto.longitudeDD, carto.latitudeDD);
  }
}

/* ===================================================
   í† ì§€ ì •ë³´ ì¡°íšŒ (WFS ë‹¨ì¼ ìš”ì²­)
=================================================== */
function fetchLandInfo(lon, lat) {
  if (!isLandParcelActive) return;

  var buf = getBuf(lon, lat);
  var bbox = (lon-buf[0])+","+(lat-buf[1])+","+(lon+buf[0])+","+(lat+buf[1]);
  var ck = "land_" + lon.toFixed(7) + "_" + lat.toFixed(7);

  if (cache[ck]) { processLandData(cache[ck], lon, lat); showMsg("ìºì‹œì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤."); return; }

  showMsg("ğŸ” í† ì§€ ì •ë³´ ì¡°íšŒ ì¤‘...");

  $.ajax({
    type: "get",
    url: "https://api.vworld.kr/req/wfs",
    data: {
      key: apiKey,
      domain: window.location.hostname || "localhost",
      SERVICE: "WFS", version: "1.1.0", request: "GetFeature",
      TYPENAME: [
        "lt_c_landinfobasemap",   // ê¸°ë³¸ ì§€ì ì •ë³´
        "lt_c_uq111","lt_c_uq112","lt_c_uq113","lt_c_uq114", // ìš©ë„ì§€ì—­
        "lt_c_upisuq161",         // ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­
        "lp_pa_cbnd_bubun"        // ê³µì‹œì§€ê°€
      ].join(","),
      OUTPUT: "text/javascript",
      SRSNAME: "EPSG:4326",
      BBOX: bbox
    },
    dataType: "jsonp",
    jsonpCallback: "parseResponse",
    success: function(data) {
      if (data && data.totalFeatures > 0) {
        cache[ck] = data;
        processLandData(data, lon, lat);
      } else {
        showMsg("ì„ íƒ ìœ„ì¹˜ì— í† ì§€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", "err");
      }
    },
    error: function() { showMsg("ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "err"); }
  });
}

/* ===================================================
   2D í•„ì§€ í•˜ì´ë¼ì´íŠ¸
=================================================== */
function addHighlight2d(geometry, pnu) {
  if (!highlightLayer) return;
  try {
    var type = geometry.type;
    var olGeom;
    if (type === 'Polygon') {
      var rings = geometry.coordinates.map(function(ring) {
        return ring.map(function(c){ return ol.proj.fromLonLat([c[0],c[1]]); });
      });
      olGeom = new ol.geom.Polygon(rings);
    } else if (type === 'MultiPolygon') {
      var polys = geometry.coordinates.map(function(poly) {
        return poly.map(function(ring){ return ring.map(function(c){ return ol.proj.fromLonLat([c[0],c[1]]); }); });
      });
      olGeom = new ol.geom.MultiPolygon(polys);
    }
    if (olGeom) {
      var feature = new ol.Feature({ geometry: olGeom, pnu: pnu });
      highlightLayer.getSource().addFeature(feature);
      selectedFeatures[pnu] = feature;
    }
  } catch(e){ console.warn('í•˜ì´ë¼ì´íŠ¸ ì¶”ê°€ ì˜¤ë¥˜:', e); }
}

function removeHighlight2d(pnu) {
  var feature = selectedFeatures[pnu];
  if (feature && highlightLayer) {
    try{ highlightLayer.getSource().removeFeature(feature); }catch(e){}
    delete selectedFeatures[pnu];
  }
}

/* ===================================================
   3D í•„ì§€ í•˜ì´ë¼ì´íŠ¸
=================================================== */
function findCesiumViewer() {
  // VWorld 3DëŠ” Cesium ê¸°ë°˜ â€” window.Cesium ë˜ëŠ” vw.Cesium ì–´ëŠ ìª½ì´ë“  í—ˆìš©
  var CesiumLib = window.Cesium || (typeof vw !== 'undefined' && vw.Cesium);
  if (!CesiumLib || !map3d) return null;

  // 1) map3d ì§ì ‘ ì†ì„± íƒìƒ‰
  var candidates = [
    map3d._viewer, map3d.viewer,
    map3d._cesiumViewer, map3d.cesiumViewer,
    map3d._widget, map3d.widget, map3d._cesiumWidget,
    map3d._scene && map3d._scene.viewer,
    (typeof map3d.getCesiumViewer === 'function') && map3d.getCesiumViewer(),
    (typeof map3d.getViewer      === 'function') && map3d.getViewer()
  ];
  for (var i = 0; i < candidates.length; i++) {
    var c = candidates[i];
    if (c && c.entities && typeof c.entities.add === 'function') return c;
  }

  // 2) #vmap DOM ìš”ì†Œ ì†ì„± íƒìƒ‰
  var vmapEl = document.getElementById('vmap');
  if (!vmapEl) return null;
  for (var k in vmapEl) {
    try {
      var v = vmapEl[k];
      if (v && typeof v === 'object' && v.entities && typeof v.entities.add === 'function') return v;
    } catch(e) {}
  }

  // 3) #vmap ì§ê³„ ìì‹ ìš”ì†Œ ì†ì„± íƒìƒ‰ (Cesium widget div)
  for (var ci = 0; ci < vmapEl.children.length; ci++) {
    var child = vmapEl.children[ci];
    for (var ck in child) {
      try {
        var cv = child[ck];
        if (cv && typeof cv === 'object' && cv.entities && typeof cv.entities.add === 'function') return cv;
      } catch(e) {}
    }
  }
  return null;
}

function addHighlight3d(geometry, pnu) {
  function doHighlight(retriesLeft) {
    try {
      var C = window.Cesium || (typeof vw !== 'undefined' && vw.Cesium);
      if (!C) {
        if (retriesLeft > 0) setTimeout(function(){ doHighlight(retriesLeft - 1); }, 600);
        return;
      }
      var viewer = findCesiumViewer();
      if (!viewer) {
        if (retriesLeft > 0) setTimeout(function(){ doHighlight(retriesLeft - 1); }, 600);
        return;
      }
      var coords = geometry.type === 'MultiPolygon'
        ? geometry.coordinates[0][0]
        : geometry.coordinates[0];
      var positions = coords.map(function(c) {
        return C.Cartesian3.fromDegrees(c[0], c[1]);
      });
      var polyEnt = viewer.entities.add({
        polygon: {
          hierarchy: new C.PolygonHierarchy(positions),
          material: C.Color.RED.withAlpha(0.3),
          classificationType: typeof C.ClassificationType !== 'undefined'
            ? C.ClassificationType.BOTH : undefined
        }
      });
      var linePositions = positions.concat([positions[0]]);
      var lineEnt = viewer.entities.add({
        polyline: {
          positions: linePositions,
          width: 3,
          material: new C.PolylineOutlineMaterialProperty({
            color: C.Color.RED,
            outlineColor: C.Color.WHITE,
            outlineWidth: 1
          }),
          clampToGround: true
        }
      });
      highlight3dEntities[pnu] = { poly: polyEnt, line: lineEnt };
    } catch(e) {
      console.warn('3D í•˜ì´ë¼ì´íŠ¸ ì˜¤ë¥˜:', e);
      if (retriesLeft > 0) setTimeout(function(){ doHighlight(retriesLeft - 1); }, 600);
    }
  }
  doHighlight(5);
}

function removeHighlight3d(pnu) {
  var ents = highlight3dEntities[pnu];
  if (ents) {
    try {
      var viewer = findCesiumViewer();
      if (viewer && viewer.entities) {
        if (ents.poly) viewer.entities.remove(ents.poly);
        if (ents.line) viewer.entities.remove(ents.line);
      }
    } catch(e){}
    delete highlight3dEntities[pnu];
  }
}

function clearHighlight() {
  if (highlightLayer) highlightLayer.getSource().clear();
  selectedFeatures = {};
  Object.keys(highlight3dEntities).forEach(function(pnu){ removeHighlight3d(pnu); });
}

/* ===================================================
   Point-in-Polygon (ë ˆì´ ìºìŠ¤íŒ…)
=================================================== */
function pointInRing(px, py, ring) {
  var inside = false;
  for (var i = 0, j = ring.length - 1; i < ring.length; j = i++) {
    var xi = ring[i][0], yi = ring[i][1], xj = ring[j][0], yj = ring[j][1];
    if (((yi > py) !== (yj > py)) && (px < (xj-xi)*(py-yi)/(yj-yi)+xi))
      inside = !inside;
  }
  return inside;
}
function pointInGeom(px, py, geom) {
  if (!geom) return false;
  if (geom.type === 'Polygon') return pointInRing(px, py, geom.coordinates[0]);
  if (geom.type === 'MultiPolygon') return geom.coordinates.some(function(p){ return pointInRing(px, py, p[0]); });
  return false;
}
function geomArea(geom) {
  var ring = geom.type === 'MultiPolygon' ? geom.coordinates[0][0] : geom.coordinates[0];
  var area = 0;
  for (var i = 0, j = ring.length-1; i < ring.length; j = i++) {
    area += (ring[j][0]+ring[i][0]) * (ring[j][1]-ring[i][1]);
  }
  return Math.abs(area)/2;
}

/* ===================================================
   BBOX ë²„í¼
=================================================== */
function getBuf(lon, lat) {
  var bx = 0.0003, by = 0.00025;
  try {
    if (currentMapType === "2d") {
      var res = map2d.getView().getResolution();
      bx = (res * 8) / 111000;
      by = (res * 8) / 111000;
    } else {
      var z = map3d.getCurrentPosition().position.z;
      bx = 1/(111000/z*1.48*50);
      by = 1/(111000/z*1.85*50);
    }
  } catch(e){}
  return [Math.max(bx, 0.00008), Math.max(by, 0.00008)];
}

/* ===================================================
   ì‘ë‹µ ì²˜ë¦¬ (ì •ë°€ PIP + ê·œì œ ì •í™•ë„ ê°œì„ )
=================================================== */
function processLandData(data, lon, lat) {
  var baseFeats = (data.features||[]).filter(function(f){
    return f.id && f.id.toLowerCase().indexOf("lt_c_landinfobasemap") >= 0;
  });
  if (baseFeats.length === 0) { showMsg("í•´ë‹¹ ìœ„ì¹˜ì— ì§€ì  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", "err"); return; }

  // PIP: í´ë¦­ì ì´ ë‚´ë¶€ì— í¬í•¨ëœ í•„ì§€ ì¤‘ ê°€ì¥ ì‘ì€ ê²ƒ
  var inside = baseFeats.filter(function(f){ return pointInGeom(lon, lat, f.geometry); });
  var best = null;
  if (inside.length > 0) {
    best = inside.reduce(function(a,b){ return geomArea(a.geometry) <= geomArea(b.geometry) ? a : b; });
  } else {
    var minD = Infinity;
    baseFeats.forEach(function(f){
      var ctr = getCenter(f.geometry);
      var d2 = dist(lon, lat, ctr[0], ctr[1]);
      if (d2 < minD){ minD = d2; best = f; }
    });
  }
  if (!best) { showMsg("í•„ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "err"); return; }

  // â”€â”€ ì„ íƒ í•„ì§€ í™”ë©´ ì¤‘ì•™ìœ¼ë¡œ ì´ë™ â”€â”€
  var parcelCenter = getCenter(best.geometry);
  if (currentMapType === "2d") {
    try {
      var mercCoord = ol.proj.fromLonLat([parcelCenter[0], parcelCenter[1]]);
      // ëª¨ë°”ì¼: ì§€ë„(55vh)ì™€ íŒ¨ë„(45vh)ì´ ë¶„ë¦¬ë˜ì–´ ì˜¤ë²„ë© ì—†ìŒ â†’ ë‹¨ìˆœ ì¤‘ì•™ ì´ë™
      map2d.getView().animate({ center: mercCoord, duration: 400 });
    } catch(e){}
  } else {
    try {
      var curPos = map3d.getCurrentPosition();
      var curAlt = (curPos && curPos.position && curPos.position.z) ? curPos.position.z : 800;
      map3d.moveTo(new vw.CameraPosition(new vw.CoordZ(parcelCenter[0], parcelCenter[1], Math.max(curAlt, 400)), new vw.Direction(0, -90, 0)));
    } catch(e){}
  }

  var d = Object.assign({}, best.properties);

  // ìš©ë„ì§€ì—­: PIP ìš°ì„ , ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ë§¤ì¹­
  var uqTypes = ["lt_c_uq111","lt_c_uq112","lt_c_uq113","lt_c_uq114"];
  var uqFeature = null;
  for (var i = 0; i < uqTypes.length && !uqFeature; i++) {
    var uqCands = (data.features||[]).filter(function(f){
      return f.id && f.id.toLowerCase().indexOf(uqTypes[i]) >= 0;
    });
    uqFeature = uqCands.find(function(f){ return f.geometry && pointInGeom(lon, lat, f.geometry); })
                || (uqCands.length > 0 ? uqCands[0] : null);
  }
  d.uname = uqFeature ? (uqFeature.properties.uname || '-') : '-';

  // ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­: PIP
  var upCands = (data.features||[]).filter(function(f){ return f.id && f.id.toLowerCase().indexOf("lt_c_upisuq161") >= 0; });
  var upF = upCands.find(function(f){ return f.geometry && pointInGeom(lon, lat, f.geometry); }) || null;
  d.dgm_nm = upF ? (upF.properties.dgm_nm || '-') : '-';

  // ê³µì‹œì§€ê°€: PIP ìš°ì„ 
  var lpCands = (data.features||[]).filter(function(f){ return f.id && f.id.toLowerCase().indexOf("lp_pa_cbnd_bubun") >= 0; });
  var lpF = lpCands.find(function(f){ return f.geometry && pointInGeom(lon, lat, f.geometry); }) || lpCands[0] || null;
  d.jiga = lpF ? (lpF.properties.jiga || '-') : '-';

  // â”€â”€ í† ê¸€: ì´ë¯¸ ì„ íƒ â†’ í•´ì œ, ìƒˆ ì„ íƒ â†’ ì¶”ê°€ â”€â”€
  var alreadySelected = collectedLandInfo.some(function(x){ return x.pnu === d.pnu; });
  if (alreadySelected) {
    removeHighlight2d(d.pnu);
    removeHighlight3d(d.pnu);
    collectedLandInfo = collectedLandInfo.filter(function(x){ return x.pnu !== d.pnu; });
    removeMarker(d.pnu);
    $('.land-item[data-pnu="' + d.pnu + '"]').remove();
    $('#mobLandTbody tr[data-pnu="' + d.pnu + '"]').remove();
    $('#mobLandTbody tr').each(function(i){ $(this).find('td:first').text(i+1); });
    if ($('#mobLandTbody tr').length === 0) $('#mobLandTableWrap').removeClass('active');
    updateCnt();
    if (collectedLandInfo.length === 0) showEmptyState();
    showMsg("ğŸ”² í•„ì§€ ì„ íƒì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "");
  } else {
    if (currentMapType === "2d") addHighlight2d(best.geometry, d.pnu);
    else addHighlight3d(best.geometry, d.pnu);
    d.ecvam_gr = '-';
    d.bio_gr   = '-';
    d._lon = parcelCenter[0];
    d._lat = parcelCenter[1];
    d._geometry = best.geometry; // ì§€ë„ ì „í™˜ ì‹œ í•˜ì´ë¼ì´íŠ¸ ë³µì›ìš©
    addLandInfo(d);        // ì¹´ë“œ ì¦‰ì‹œ ì¶”ê°€ (ë“±ê¸‰ì€ '-' í‘œì‹œ í›„ ì—…ë°ì´íŠ¸)
    addMarker(lon, lat, d);
    autoOpenMobileSheet();
    showMsg("âœ… í† ì§€ ì •ë³´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.", "ok");
    /* ECVAM ë“±ê¸‰ ë¹„ë™ê¸° ì¡°íšŒ â†’ ì¹´ë“œ ì—…ë°ì´íŠ¸ */
    fetchEcvamGrade(lon, lat, function(ecvamResult) {
      updateEcvamGradeOnCard(d.pnu, ecvamResult);
    });
  }
}

/* ===================================================
   í† ì§€ ì¹´ë“œ ì¶”ê°€ (ìƒˆì°½ ë²„íŠ¼ + ì„¹ì…˜ ì ‘ê¸°/í¼ì¹˜ê¸°)
=================================================== */
function addLandInfo(d) {
  $(".empty-state").remove();
  collectedLandInfo.push(d);

  var addr = [d.sido_nm, d.sgg_nm, d.emd_nm, d.ri_nm, d.jibun].filter(Boolean).map(escHtml).join(' ');
  var fmt = function(v){ return (v && v !== '-' && !isNaN(v)) ? Number(v).toLocaleString() : (v || '-'); };
  var safePnu = escAttr(d.pnu);

  var $item = $('<div class="land-item" data-pnu="' + escHtml(d.pnu) + '"></div>');
  $item.append(
    '<div class="land-item-hd">' +
      '<span title="' + addr + '">' + addr + '</span>' +
      '<button class="newwin-btn" onclick="openInNewWindow(\'' + safePnu + '\')">ğŸ”— ìƒˆì°½</button>' +
      '<button class="del-btn" data-pnu="' + escHtml(d.pnu) + '">ì‚­ì œ</button>' +
    '</div>'
  );

  var addrShort = [d.emd_nm, d.ri_nm, d.jibun].filter(Boolean).map(escHtml).join(' ');
  var rawArea = d.area_ || d.parea;
  var areaDisp = (rawArea && !isNaN(rawArea)) ? Math.round(Number(rawArea)).toLocaleString() : '-';

  // â”€â”€ ì‹¬í”Œ key:value ì¹´ë“œ (ë°ìŠ¤í¬íƒ‘ìš©) â”€â”€
  function kv(k, v) {
    return '<div class="land-kv-row"><span class="land-kv-k">' + escHtml(k) + '</span><span class="land-kv-v">' + escHtml(v || '-') + '</span></div>';
  }
  var $kv = $('<div class="land-kv"></div>');
  $kv.append('<div class="land-kv-sec">ğŸ“ ê¸°ë³¸ì •ë³´</div>');
  $kv.append(kv('ì§€ëª©', d.jimok));
  $kv.append(kv('ë©´ì ', areaDisp + ' ã¡'));
  $kv.append(kv('ê³µì‹œì§€ê°€', fmt(d.jiga) !== '-' ? fmt(d.jiga) + ' ì›/ã¡' : '-'));
  var _jigoNum = parseFloat(String(d.jiga || '').replace(/,/g, ''));
  var _areaNum = parseFloat(rawArea || 0);
  var _jigaTotal = (!isNaN(_jigoNum) && _jigoNum > 0 && !isNaN(_areaNum) && _areaNum > 0) ? Math.round(_areaNum * _jigoNum) : null;
  $kv.append('<div class="land-kv-row"><span class="land-kv-k">í† ì§€ ê³µì‹œì§€ê°€ ì´ì•¡</span><span class="land-kv-v jiga-total-val" data-jiga-raw="' + (_jigaTotal || 0) + '" style="color:#e67e22;font-weight:800;">' + (_jigaTotal ? formatJiga(_jigaTotal) : '-') + '</span></div>');
  $kv.append('<div class="land-kv-sec">ğŸ— ìš©ë„ê³„íš</div>');
  $kv.append(kv('ìš©ë„ì§€ì—­', d.uname));
  $kv.append(kv('ì§€êµ¬ë‹¨ìœ„ê³„íš', d.dgm_nm));
  $item.append($kv);
  $("#landList").append($item);

  // â”€â”€ ëª¨ë°”ì¼ í…Œì´ë¸” í–‰ ì¶”ê°€ â”€â”€
  var seq = collectedLandInfo.length;
  var $tr = $('<tr data-pnu="' + escHtml(d.pnu) + '"></tr>');
  $tr.html(
    '<td>' + seq + '</td>' +
    '<td style="text-align:left;padding-left:8px">' + addrShort + '</td>' +
    '<td>' + escHtml(d.jimok || '-') + '</td>' +
    '<td>' + areaDisp + '</td>' +
    '<td>' + escHtml(d.uname || '-') + '</td>' +
    '<td>' + escHtml(d.dgm_nm || '-') + '</td>' +
    '<td><button class="mob-del-btn" data-pnu="' + escHtml(d.pnu) + '">ì‚­</button></td>'
  );
  $('#mobLandTbody').append($tr);
  $('#mobLandTableWrap').addClass('active');

  updateCnt();
  sortLandList();
}

/* ===================================================
   ìƒˆì°½ ë³´ê¸°
=================================================== */
function openInNewWindow(pnu) {
  var d = collectedLandInfo.find(function(x){ return x.pnu === pnu; });
  if (!d) return;
  var addr = [d.sido_nm, d.sgg_nm, d.emd_nm, d.ri_nm, d.jibun].filter(Boolean).join(' ');
  var fmt = function(v){ return (v && v !== '-' && !isNaN(v)) ? Number(v).toLocaleString() : (v || '-'); };

  var _area2 = parseFloat(d.area_ || d.parea || 0);
  var _jiga2 = parseFloat(String(d.jiga || '').replace(/,/g, ''));
  var _jigaTotal2 = (!isNaN(_area2) && _area2 > 0 && !isNaN(_jiga2) && _jiga2 > 0) ? Math.round(_area2 * _jiga2) : null;

  var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">' +
    '<meta name="viewport" content="width=device-width,initial-scale=1">' +
    '<title>' + addr + ' - í† ì§€ì •ë³´</title>' +
    '<style>' +
    'body{font-family:"Malgun Gothic","Apple SD Gothic Neo",sans-serif;margin:0;padding:16px;background:#f4f6fb;font-size:13px;}' +
    'h2{color:#3a7bd5;margin:0 0 12px;font-size:15px;font-weight:700;}' +
    '.card{background:#fff;border-radius:10px;padding:0;box-shadow:0 2px 12px rgba(0,0,0,.1);overflow:hidden;margin-bottom:12px;}' +
    'table{width:100%;border-collapse:collapse;}' +
    'tr{border-bottom:1px solid #f0f3fb;}' +
    'tr:last-child{border-bottom:none;}' +
    'td{padding:8px 12px;font-size:13px;}' +
    'td:first-child{color:#555;font-weight:600;width:42%;background:#fafbff;}' +
    'td:last-child{color:#222;}' +
    '.sec{background:#f0f4ff;padding:8px 12px;font-weight:700;color:#3a7bd5;font-size:11px;letter-spacing:.5px;}' +
    '.footer{font-size:10px;color:#aaa;text-align:center;margin-top:8px;}' +
    '</style></head><body>' +
    '<h2>ğŸ“Œ ' + addr + '</h2>' +
    '<div class="card"><table>' +
    '<tr><td class="sec" colspan="2">ğŸ“Œ ê¸°ë³¸ ì§€ì  ì •ë³´</td></tr>' +
    '<tr><td>í•„ì§€ë²ˆí˜¸(PNU)</td><td>' + (d.pnu||'-') + '</td></tr>' +
    '<tr><td>ì§€ë²ˆ</td><td>' + (d.jibun||'-') + '</td></tr>' +
    '<tr><td>ì§€ëª©</td><td>' + (d.jimok||'-') + '</td></tr>' +
    '<tr><td>ë©´ì (ã¡)</td><td>' + fmt(d.area_||d.parea) + '</td></tr>' +
    '<tr><td class="sec" colspan="2">ğŸ’° ê³µì‹œ ì •ë³´</td></tr>' +
    '<tr><td>ê³µì‹œì§€ê°€(ì›/ã¡)</td><td>' + fmt(d.jiga) + '</td></tr>' +
    '<tr><td>í† ì§€ ê³µì‹œì§€ê°€ ì´ì•¡</td><td style="color:#e67e22;font-weight:700;">' + (_jigaTotal2 ? _jigaTotal2.toLocaleString('ko-KR') + ' ì›' : '-') + '</td></tr>' +
    '<tr><td class="sec" colspan="2">ğŸ— ìš©ë„ê³„íšì •ë³´</td></tr>' +
    '<tr><td>ìš©ë„ì§€ì—­</td><td>' + (d.uname||'-') + '</td></tr>' +
    '<tr><td>ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­</td><td>' + (d.dgm_nm||'-') + '</td></tr>' +
    '</table></div>' +
    '<p class="footer">VWorld API Â· í† ì§€ì •ë³´ì¡°íšŒì‹œìŠ¤í…œ Â· ' + new Date().toLocaleDateString('ko-KR') + '</p>' +
    '</body></html>';

  var win = window.open('', '_blank', 'width=480,height=660,menubar=no,toolbar=no,location=no,status=no');
  if (win) { win.document.write(html); win.document.close(); }
  else { showMsg("íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.", "err"); }
}

/* ===================================================
   ëª¨ë°”ì¼ Bottom Sheet í† ê¸€
=================================================== */
function toggleMobileSheet() {
  var $side = $("#sidePanel");
  var $toggle = $("#sheetPullToggle");
  var $mapArea = $(".map-area");
  if ($side.hasClass("sheet-collapsed")) {
    // í¼ì¹˜ê¸° â†’ ì§€ë„ 55vh ë³µì›
    $side.removeClass("sheet-collapsed");
    $toggle.text("â–¼");
    $mapArea.css("height", "55vh");
  } else {
    // ì ‘ê¸° â†’ ì§€ë„ ì „ì²´í™”ë©´
    $side.addClass("sheet-collapsed");
    $toggle.text("â–²");
    $mapArea.css("height", "calc(100vh - 44px)");
  }
  setTimeout(function() { try { map2d.updateSize(); } catch(e) {} }, 320);
}

function autoOpenMobileSheet() {
  if (window.innerWidth <= 768) {
    // íŒ¨ë„ì´ ì ‘í˜€ìˆìœ¼ë©´ í¼ì¹˜ê¸° (ê¸°ë³¸: í•­ìƒ ì—´ë ¤ìˆìŒ)
    $("#sidePanel").removeClass("sheet-collapsed");
    $("#sheetPullToggle").text("â–¼");
    $(".map-area").css("height", "55vh");
    setTimeout(function() { try { map2d.updateSize(); } catch(e) {} }, 320);
  }
}

function updateSheetLabel() {
  var cnt = collectedLandInfo.length;
  if (cnt === 0) {
    $("#sheetPullLabel").text("í† ì§€ì •ë³´ë¥¼ í´ë¦­í•˜ì—¬ ì¡°íšŒí•˜ì„¸ìš”");
  } else {
    var totalArea = collectedLandInfo.reduce(function(sum, d){
      var a = parseFloat(d.area_ || d.parea || 0);
      return sum + (isNaN(a) ? 0 : a);
    }, 0);
    $("#sheetPullLabel").text(cnt + "í•„ì§€ Â· " + Math.round(totalArea).toLocaleString() + "ã¡");
  }
}

/* ===================================================
   ë§ˆì»¤
=================================================== */
function addMarker(lon, lat, d) {
  var addr = [d.emd_nm, d.jibun].filter(Boolean).join(' ');
  var fmt = function(v){ return (v && !isNaN(v)) ? Number(v).toLocaleString() : (v||'-'); };
  var markerOpt = {
    x: lon, y: lat, epsg: 'EPSG:4326',
    title: addr,
    contents: 'ì§€ëª©: ' + (d.jimok||'-') + '<br>ìš©ë„ì§€ì—­: ' + (d.uname||'-') + '<br>ë©´ì : ' + fmt(d.area_||d.parea) + 'ã¡',
    iconUrl: 'https://map.vworld.kr/images/ol3/marker_red.png',
    text: {
      offsetX: 0.5, offsetY: -10,
      font: '12px Malgun Gothic,sans-serif',
      fill: { color: '#1a3a7a' },
      stroke: { color: '#fff', width: 2 },
      text: addr
    },
    attr: { id: 'mk_' + d.pnu }
  };
  var mk = markerLayer.addMarker(markerOpt);
  markers.push({ pnu: d.pnu, marker: mk });
}

function removeMarker(pnu) {
  var m = markers.find(function(x){ return x.pnu === pnu; });
  if (m) { try{ markerLayer.removeMarker(m.marker); }catch(e){} markers = markers.filter(function(x){ return x.pnu !== pnu; }); }
}

/* ===================================================
   ì‚­ì œ / ì „ì²´ ì‚­ì œ
=================================================== */
$(document).on('click', '.del-btn, .mob-del-btn', function() {
  var pnu = $(this).data('pnu');
  removeHighlight2d(pnu);
  removeHighlight3d(pnu);
  collectedLandInfo = collectedLandInfo.filter(function(x){ return x.pnu !== pnu; });
  removeMarker(pnu);
  $('.land-item[data-pnu="' + pnu + '"]').remove();
  $('#mobLandTbody tr[data-pnu="' + pnu + '"]').remove();
  $('#mobLandTbody tr').each(function(i){ $(this).find('td:first').text(i + 1); });
  if ($('#mobLandTbody tr').length === 0) $('#mobLandTableWrap').removeClass('active');
  updateCnt();
  if (collectedLandInfo.length === 0) showEmptyState();
  showMsg("ì„ íƒí•œ í† ì§€ ì •ë³´ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.");
});

function clearLandInfo() {
  if (!collectedLandInfo.length) return;
  if (!confirm("ìˆ˜ì§‘ëœ ëª¨ë“  í† ì§€ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  clearHighlight();
  collectedLandInfo = [];
  markers.forEach(function(m){ try{ markerLayer.removeMarker(m.marker); }catch(e){} });
  markers = [];
  $("#landList .land-item").remove();
  $("#mobLandTbody").empty();
  $("#mobLandTableWrap").removeClass('active');
  showEmptyState();
  updateCnt();
  showMsg("ëª¨ë“  í† ì§€ ì •ë³´ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.");
}

function showEmptyState() {
  if (!$('#landList .empty-state').length) {
    $('#landList').append('<div class="empty-state"><div class="ico">ğŸ“</div><p>ì§€ë„ì—ì„œ í† ì§€ë¥¼ í´ë¦­í•˜ë©´<br>ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</p></div>');
  }
}

function updateCnt() {
  var cnt = collectedLandInfo.length;
  $("#landCnt").text("ì´ " + cnt + "ê±´");
  
  var totalArea = 0;
  var totalJigaSum = 0;
  
  collectedLandInfo.forEach(function(d) {
    var a = parseFloat(d.area_ || d.parea || 0);
    if (!isNaN(a)) totalArea += a;
    
    // ê³µì‹œì§€ê°€ í•©ê³„ (ë©´ì  * ê³µì‹œì§€ê°€)
    var j = String(d.jiga || '0').replace(/,/g, '');
    var jNum = parseFloat(j);
    if (!isNaN(a) && !isNaN(jNum) && jNum > 0) {
      totalJigaSum += (a * jNum);
    }
  });

  if (cnt > 0) {
    $("#areaCnt").text(cnt);
    var display = totalArea.toLocaleString('ko-KR', { maximumFractionDigits:1 }) + ' ã¡';
    var pyeong = (totalArea * 0.3025).toLocaleString('ko-KR', { maximumFractionDigits:1 });
    $("#areaSumVal").text(display + '  â‰ˆ  ' + pyeong + ' í‰');
    
    // ê³µì‹œì§€ê°€ ì´ì•¡ í‘œì‹œ
    if (totalJigaSum > 0) {
      $("#jigaSumVal").text(formatJiga(Math.round(totalJigaSum)));
      $("#jigaSumRow").show();
    } else {
      $("#jigaSumVal").text('0 ì›');
      $("#jigaSumRow").hide();
    }
    
    $("#areaSumBar").show();
  } else {
    $("#areaSumBar").hide();
  }
  updateSheetLabel();
}

/* ===================================================
   ì£¼ì†Œ ê²€ìƒ‰ (ê²°ê³¼ ëª©ë¡ í‘œì‹œ)
=================================================== */
function closeAddrResults() {
  $('#addrResults').remove();
}

function selectAddrResult(lon, lat, label) {
  closeAddrResults();
  $("#addrInput").val(label);
  moveTo(lon, lat);
  showMsg("ğŸ“ '" + label + "' ìœ„ì¹˜ë¡œ ì´ë™ ì¤‘...", "ok");
  if (isLandParcelActive) { setTimeout(function(){ fetchLandInfo(lon, lat); }, 400); }
}

function showAddrResults(items) {
  closeAddrResults();
  if (!items || items.length === 0) { showMsg("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "err"); return; }

  var $drop = $('<div id="addrResults" class="addr-results"></div>');
  items.forEach(function(item) {
    var pt = item.point;
    if (!pt) return;
    var lon = parseFloat(pt.x), lat = parseFloat(pt.y);
    var address = (item.address && typeof item.address === 'object')
      ? (item.address.road || item.address.parcel || '')
      : (item.address || '');
    var label = item.title || item.name || address;
    var $r = $('<div class="addr-result-item"></div>');
    $r.append('<span class="addr-result-name">' + label + '</span>');
    if (address && address !== label) {
      $r.append('<span class="addr-result-addr">' + address + '</span>');
    }
    $r.on('click', function(){ selectAddrResult(lon, lat, label); });
    $drop.append($r);
  });

  $('.search-row').append($drop);
  // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
  setTimeout(function(){
    $(document).one('click.addrClose', function(e){
      if (!$(e.target).closest('#addrResults, #addrInput').length) closeAddrResults();
    });
  }, 100);
}

function searchAddress() {
  var q = $("#addrInput").val().trim();
  if (!q) { showMsg("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "err"); return; }
  closeAddrResults();
  showMsg("ğŸ” ì£¼ì†Œë¥¼ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...");
  // "ì‚° NN" ë˜ëŠ” "ì‚°NN" íŒ¨í„´ì´ë©´ ë„ë¡œëª… ê²€ìƒ‰ ì—†ì´ ë°”ë¡œ ì§€ë²ˆ ê²€ìƒ‰
  if (/ì‚°[\s\d]/.test(q)) { searchParcel(q); return; }
  $.ajax({
    type:"get", url:"https://api.vworld.kr/req/search",
    data:{ service:"search", version:"2.0", request:"search", key:apiKey,
           format:"json", size:8, page:1, query:q, type:"address", category:"road", crs:"EPSG:4326" },
    dataType:"jsonp",
    success: function(data) {
      var items = (data.response.status === "OK") ? (data.response.result.items || []) : [];
      if (items.length > 0) {
        if (items.length === 1) {
          selectAddrResult(parseFloat(items[0].point.x), parseFloat(items[0].point.y), extractLabel(items[0], q));
        } else {
          showAddrResults(items);
        }
      } else {
        searchParcel(q);
      }
    },
    error: function(){ searchParcel(q); }
  });
}

/* "ì‚°12" â†” "ì‚° 12" ê³µë°± ì •ê·œí™” (VWorld API í¬ë§· ëŒ€ì‘) */
function normSanJibun(q) {
  // "ì‚°12-3" í˜•íƒœ â†’ "ì‚° 12-3" (ê³µë°± ì¶”ê°€)
  if (/ì‚°(\d)/g.test(q)) return q.replace(/ì‚°(\d)/g, 'ì‚° $1');
  // "ì‚° 12-3" í˜•íƒœ â†’ "ì‚°12-3" (ê³µë°± ì œê±°)
  if (/ì‚° (\d)/g.test(q)) return q.replace(/ì‚° (\d)/g, 'ì‚°$1');
  return q;
}

function searchParcel(q, _fallback) {
  $.ajax({
    type:"get", url:"https://api.vworld.kr/req/search",
    data:{ service:"search", version:"2.0", request:"search", key:apiKey,
           format:"json", size:8, page:1, query:q, type:"address", category:"parcel", crs:"EPSG:4326" },
    dataType:"jsonp",
    success: function(data) {
      var items = (data.response.status === "OK") ? (data.response.result.items || []) : [];
      if (items.length > 0) {
        if (items.length === 1) {
          selectAddrResult(parseFloat(items[0].point.x), parseFloat(items[0].point.y), extractLabel(items[0], q));
        } else {
          showAddrResults(items);
        }
      } else if (!_fallback && /ì‚°[\s\d]/.test(q)) {
        // ì‚° ì§€ë²ˆ ê³µë°± ì •ê·œí™” í›„ 1íšŒ ì¬ì‹œë„
        var qAlt = normSanJibun(q);
        if (qAlt !== q) {
          searchParcel(qAlt, true);
        } else {
          showMsg("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + q, "err");
        }
      } else {
        showMsg("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + q, "err");
      }
    },
    error: function(){ showMsg("ì£¼ì†Œ ê²€ìƒ‰ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "err"); }
  });
}

function moveTo(lon, lat) {
  if (currentMapType === "2d") {
    try { map2d.updateSize(); } catch(e) {}
    map2d.getView().animate({ center: ol.proj.fromLonLat([lon, lat]), zoom: 18, duration: 400 });
  } else {
    map3d.moveTo(new vw.CameraPosition(
      new vw.CoordZ(lon, lat, 800),
      new vw.Direction(0, -90, 0)
    ));
  }
}

/* ===================================================
   í† ì§€ ëª©ë¡ ìƒˆì°½ ì—´ê¸°
=================================================== */
// ìƒˆì°½ì—ì„œ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ë¶€ëª¨ì°½ì—ì„œë„ í•´ë‹¹ í•„ì§€ ì œê±°
window.deleteLandFromChild = function(pnu) {
  removeHighlight2d(pnu);
  removeHighlight3d(pnu);
  collectedLandInfo = collectedLandInfo.filter(function(x){ return x.pnu !== pnu; });
  removeMarker(pnu);
  $('.land-item[data-pnu="' + pnu + '"]').remove();
  $('#mobLandTbody tr[data-pnu="' + pnu + '"]').remove();
  $('#mobLandTbody tr').each(function(i){ $(this).find('td:first').text(i + 1); });
  if ($('#mobLandTbody tr').length === 0) $('#mobLandTableWrap').removeClass('active');
  updateCnt();
  if (collectedLandInfo.length === 0) showEmptyState();
};

function openTableWindow() {
  if (!collectedLandInfo.length) { showMsg("í‘œì‹œí•  í† ì§€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", "err"); return; }

  var fmt = function(v){ return (v && v !== '-' && !isNaN(v)) ? Number(v).toLocaleString() : (v || '-'); };
  var totalArea = collectedLandInfo.reduce(function(s, d){
    return s + (parseFloat(d.area_ || d.parea || 0) || 0);
  }, 0);
  var totalJigaWin = collectedLandInfo.reduce(function(s, d){
    var a = parseFloat(d.area_ || d.parea || 0) || 0;
    var j = parseFloat(String(d.jiga || '').replace(/,/g,'')) || 0;
    return s + (j > 0 ? Math.round(a * j) : 0);
  }, 0);
  var cnt = collectedLandInfo.length;

  var rows = collectedLandInfo.map(function(d, i) {
    var addr = [d.sido_nm, d.sgg_nm, d.emd_nm, d.ri_nm, d.jibun].filter(Boolean).map(escHtml).join(' ');
    var area = parseFloat(d.area_ || d.parea || 0);
    var areaDisp = isNaN(area) ? '-' : Math.round(area).toLocaleString();
    var jigaNum = parseFloat(String(d.jiga || '').replace(/,/g,''));
    var jigaRaw = (!isNaN(area) && area > 0 && !isNaN(jigaNum) && jigaNum > 0) ? Math.round(area * jigaNum) : 0;
    var safePnu = escAttr(d.pnu);
    return '<tr data-pnu="' + safePnu + '">' +
      '<td>' + (i + 1) + '</td>' +
      '<td class="al">' + addr + '</td>' +
      '<td>' + escHtml(d.jimok || '-') + '</td>' +
      '<td class="ar">' + areaDisp + '</td>' +
      '<td class="ar">' + escHtml(fmt(d.jiga)) + '</td>' +
      '<td class="ar jiga-cell" data-raw="' + jigaRaw + '" style="color:#c0392b;font-weight:700;">' + (jigaRaw > 0 ? jigaRaw.toLocaleString('ko-KR') + ' ì›' : '-') + '</td>' +
      '<td>' + escHtml(d.uname || '-') + '</td>' +
      '<td>' + escHtml(d.dgm_nm || '-') + '</td>' +
      '<td><button class="btn-del" onclick="deleteRow(\'' + safePnu + '\',this)">ì‚­ì œ</button></td>' +
    '</tr>';
  }).join('');

  var dataJson = JSON.stringify(collectedLandInfo.map(function(d){
    return {
      pnu: d.pnu||'', sido: d.sido_nm||'', sgg: d.sgg_nm||'',
      emd: d.emd_nm||'', ri: d.ri_nm||'', jibun: d.jibun||'',
      jimok: d.jimok||'', area: d.area_||d.parea||'', jiga: d.jiga||'',
      uname: d.uname||'', dgm_nm: d.dgm_nm||''
    };
  }));

  var html = '<!DOCTYPE html><html><head>' +
    '<meta charset="UTF-8">' +
    '<meta name="viewport" content="width=device-width,initial-scale=1">' +
    '<title>í† ì§€ ëª©ë¡ (' + cnt + 'í•„ì§€)</title>' +
    '<style>' +
    '*{box-sizing:border-box;}' +
    'body{font-family:"Malgun Gothic","Apple SD Gothic Neo",sans-serif;margin:0;padding:20px;background:#f8f9fb;font-size:13px;color:#222;}' +
    '.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;}' +
    'h2{margin:0;font-size:17px;font-weight:700;color:#1a2a4a;}' +
    '.summary{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;}' +
    '.sum-card{background:#fff;border:1px solid #d8dde8;border-left:4px solid #3a7bd5;border-radius:6px;padding:10px 20px;min-width:140px;}' +
    '.sum-label{font-size:11px;color:#777;margin-bottom:4px;}' +
    '.sum-val{font-size:20px;font-weight:700;color:#1a2a4a;}' +
    '.sum-sub{font-size:11px;color:#555;margin-top:3px;}' +
    '.btn-csv{padding:7px 16px;background:#1a6fb5;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:12px;font-weight:600;}' +
    '.btn-csv:hover{background:#155a94;}' +
    '.btn-del{padding:3px 10px;background:#c0392b;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;}' +
    '.btn-del:hover{background:#a93226;}' +
    '.tbl-wrap{overflow-x:auto;border:1px solid #d0d5e0;border-radius:6px;background:#fff;}' +
    'table{width:100%;border-collapse:collapse;white-space:nowrap;}' +
    'thead th{background:#2c4a7a;color:#fff;padding:9px 11px;text-align:center;font-size:12px;font-weight:700;position:sticky;top:0;border-right:1px solid #3a5f9a;}' +
    'thead th:last-child{border-right:none;}' +
    'tbody td{padding:7px 11px;border-bottom:1px solid #eaecf4;border-right:1px solid #eaecf4;font-size:12px;text-align:center;}' +
    'tbody td:last-child{border-right:none;}' +
    'tbody td.al{text-align:left;}' +
    'tbody td.ar{text-align:right;}' +
    'tbody tr:nth-child(even) td{background:#f5f7fc;}' +
    'tbody tr:hover td{background:#e8eef8;}' +
    'tfoot td{padding:8px 11px;font-size:12px;font-weight:700;background:#edf1f9;border-top:2px solid #b0bcd8;border-right:1px solid #d0d5e0;text-align:center;}' +
    'tfoot td:last-child{border-right:none;}' +
    '.foot{margin-top:10px;text-align:right;font-size:11px;color:#aaa;}' +
    '@media print{.btn-csv,.btn-del{display:none;} body{padding:8px;}}' +
    '</style></head><body>' +
    '<div class="header"><h2>í† ì§€ ëª©ë¡</h2>' +
      '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">' +
        '<span style="font-size:11px;color:#777;font-weight:600;">ì •ë ¬:</span>' +
        '<button id="ws0" class="wsort" onclick="sortTable(\'newest\')" style="padding:3px 9px;border:1px solid #b0bcd8;border-radius:4px;background:#3a7bd5;color:#fff;font-size:11px;font-weight:700;cursor:pointer;">ìµœì‹ ìˆœ</button>' +
        '<button id="ws1" class="wsort" onclick="sortTable(\'asc\')" style="padding:3px 9px;border:1px solid #b0bcd8;border-radius:4px;background:#eaf0fb;color:#3a7bd5;font-size:11px;font-weight:700;cursor:pointer;">ì§€ë²ˆâ–²</button>' +
        '<button id="ws2" class="wsort" onclick="sortTable(\'desc\')" style="padding:3px 9px;border:1px solid #b0bcd8;border-radius:4px;background:#eaf0fb;color:#3a7bd5;font-size:11px;font-weight:700;cursor:pointer;">ì§€ë²ˆâ–¼</button>' +
        '<span style="color:#ddd;">|</span>' +
        '<span style="font-size:11px;color:#777;font-weight:600;">ê¸ˆì•¡ë‹¨ìœ„:</span>' +
        '<select onchange="changeUnit(this.value)" style="border:1px solid #b0bcd8;border-radius:5px;background:#eaf3fb;color:#1a5fa8;font-size:12px;font-weight:700;padding:3px 7px;cursor:pointer;outline:none;">' +
          '<option value="ì›">ì›</option>' +
          '<option value="ì²œì›">ì²œì›</option>' +
          '<option value="ë°±ë§Œì›">ë°±ë§Œì›</option>' +
          '<option value="ì–µì›">ì–µì›</option>' +
        '</select>' +
        '<button class="btn-csv" onclick="exportCSV()">í† ì§€ì¡°ì„œ ë‚´ë³´ë‚´ê¸° (CSV)</button>' +
      '</div>' +
    '</div>' +
    '<div class="summary">' +
      '<div class="sum-card"><div class="sum-label">ì´ í•„ì§€ ìˆ˜</div><div class="sum-val" id="sumCnt">' + cnt + ' í•„ì§€</div></div>' +
      '<div class="sum-card"><div class="sum-label">ë©´ì  í•©ê³„</div><div class="sum-val" id="sumArea">' + Math.round(totalArea).toLocaleString() + ' ã¡</div>' +
        '<div class="sum-sub" id="sumPyeong">â‰ˆ ' + Math.round(totalArea * 0.3025).toLocaleString() + ' í‰</div></div>' +
      '<div class="sum-card" style="border-left-color:#e67e22;"><div class="sum-label">ê³µì‹œì§€ê°€ ì´ì•¡</div><div class="sum-val" id="sumJiga" style="color:#c0392b;">' + totalJigaWin.toLocaleString('ko-KR') + ' ì›</div></div>' +
    '</div>' +
    '<div class="tbl-wrap"><table>' +
    '<thead><tr><th>ìˆœë²ˆ</th><th>ì£¼ì†Œ</th><th>ì§€ëª©</th><th>ë©´ì (ã¡)</th>' +
      '<th>ê³µì‹œì§€ê°€(ì›/ã¡)</th><th>ê³µì‹œì§€ê°€ ì´ì•¡(ì›)</th><th>ìš©ë„ì§€ì—­</th><th>ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­</th><th>ì‚­ì œ</th>' +
    '</tr></thead>' +
    '<tbody id="tbl-body">' + rows + '</tbody>' +
    '<tfoot><tr>' +
      '<td colspan="3" style="text-align:right;">í•©  ê³„</td>' +
      '<td id="footArea" style="text-align:right;">' + Math.round(totalArea).toLocaleString() + '</td>' +
      '<td></td>' +
      '<td id="footJiga" style="text-align:right;color:#c0392b;font-weight:700;">' + totalJigaWin.toLocaleString('ko-KR') + ' ì›</td>' +
      '<td colspan="3"></td>' +
    '</tr></tfoot>' +
    '</table></div>' +
    '<div class="foot">í† ì§€ì •ë³´ ì¡°íšŒ ì‹œìŠ¤í…œ &nbsp;Â·&nbsp; ' + new Date().toLocaleDateString('ko-KR') + '</div>' +
    '<script>' +
    'var _data=' + dataJson + ';' +
    'var _origOrder=_data.map(function(d){return d.pnu;});' +
    'function naturalCmpW(a,b){' +
    '  var as=/^ì‚°/.test(String(a))?1:0,bs=/^ì‚°/.test(String(b))?1:0;' +
    '  if(as!==bs)return as-bs;' +
    '  var ap=String(a).replace(/^ì‚°\\s*/,"").split("-"),bp=String(b).replace(/^ì‚°\\s*/,"").split("-");' +
    '  var am=parseInt(ap[0])||0,bm=parseInt(bp[0])||0;' +
    '  if(am!==bm)return am-bm;' +
    '  return(parseInt(ap[1])||0)-(parseInt(bp[1])||0);' +
    '}' +
    'function sortTable(mode){' +
    '  document.querySelectorAll(".wsort").forEach(function(b){b.style.background="#eaf0fb";b.style.color="#3a7bd5";});' +
    '  var btn=mode==="newest"?document.getElementById("ws0"):mode==="asc"?document.getElementById("ws1"):document.getElementById("ws2");' +
    '  if(btn){btn.style.background="#3a7bd5";btn.style.color="#fff";}' +
    '  var sorted=_data.slice();' +
    '  if(mode==="asc")sorted.sort(function(a,b){return naturalCmpW(a.jibun||"",b.jibun||"");});' +
    '  else if(mode==="desc")sorted.sort(function(a,b){return naturalCmpW(b.jibun||"",a.jibun||"");});' +
    '  else{var om={};_origOrder.forEach(function(p,i){om[p]=i;});sorted.sort(function(a,b){return om[b.pnu]-om[a.pnu];});}' +
    '  var tbody=document.getElementById("tbl-body");' +
    '  var rows={};tbody.querySelectorAll("tr").forEach(function(r){rows[r.dataset.pnu]=r;});' +
    '  while(tbody.firstChild)tbody.removeChild(tbody.firstChild);' +
    '  sorted.forEach(function(d,i){var r=rows[d.pnu];if(r){r.cells[0].textContent=i+1;tbody.appendChild(r);}});' +
    '}' +
    'var wUnit="ì›";' +
    'function fmtJiga(r){' +
    '  if(!r||r<=0)return"-";' +
    '  if(wUnit==="ì–µì›")return(r/100000000).toFixed(2)+" ì–µì›";' +
    '  if(wUnit==="ë°±ë§Œì›")return(r/1000000).toFixed(2)+" ë°±ë§Œì›";' +
    '  if(wUnit==="ì²œì›")return(r/1000).toFixed(2)+" ì²œì›";' +
    '  return Math.round(r).toLocaleString()+" ì›";' +
    '}' +
    'function changeUnit(u){' +
    '  wUnit=u;' +
    '  document.querySelectorAll(".jiga-cell").forEach(function(el){' +
    '    var raw=parseFloat(el.dataset.raw||0);' +
    '    el.textContent=raw>0?fmtJiga(raw):"-";' +
    '  });' +
    '  updateSummary();' +
    '}' +
    'function updateSummary(){' +
    '  var tot=0,jigaTot=0;' +
    '  _data.forEach(function(d){' +
    '    var a=parseFloat(d.area||0);if(!isNaN(a))tot+=a;' +
    '    var j=parseFloat(String(d.jiga||"").replace(/,/g,""));' +
    '    if(!isNaN(a)&&a>0&&!isNaN(j)&&j>0)jigaTot+=Math.round(a*j);' +
    '  });' +
    '  document.getElementById("sumCnt").textContent=_data.length+" í•„ì§€";' +
    '  document.getElementById("sumArea").textContent=Math.round(tot).toLocaleString()+" ã¡";' +
    '  document.getElementById("sumPyeong").textContent="â‰ˆ "+Math.round(tot*0.3025).toLocaleString()+" í‰";' +
    '  document.getElementById("footArea").textContent=Math.round(tot).toLocaleString();' +
    '  var sj=document.getElementById("sumJiga");if(sj)sj.textContent=fmtJiga(jigaTot);' +
    '  var fj=document.getElementById("footJiga");if(fj)fj.textContent=fmtJiga(jigaTot);' +
    '}' +
    'function deleteRow(pnu,btn){' +
    '  if(window.opener&&!window.opener.closed){window.opener.deleteLandFromChild(pnu);}' +
    '  _data=_data.filter(function(d){return d.pnu!==pnu;});' +
    '  var row=btn.closest("tr");row.parentNode.removeChild(row);' +
    '  document.querySelectorAll("#tbl-body tr").forEach(function(r,i){r.cells[0].textContent=i+1;});' +
    '  updateSummary();' +
    '}' +
    'function exportCSV(){' +
    '  var fmt=function(v){return(v&&!isNaN(v))?Number(v).toLocaleString():(v||"");};' +
    '  var csv="\\uFEFFìˆœë²ˆ,í•„ì§€ë²ˆí˜¸(PNU),ì‹œë„,ì‹œêµ°êµ¬,ìë©´ë™,ë¦¬,ì§€ë²ˆ,ì§€ëª©,ë©´ì (ã¡),ê³µì‹œì§€ê°€(ì›/ã¡),ê³µì‹œì§€ê°€ ì´ì•¡(ì›),ìš©ë„ì§€ì—­,ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­\\n";' +
    '  var tot=0,jigaTot=0;' +
    '  _data.forEach(function(d,i){' +
    '    var a=parseFloat(d.area||0);if(!isNaN(a))tot+=a;' +
    '    var j=parseFloat(String(d.jiga||"").replace(/,/g,""));' +
    '    var jt=(!isNaN(a)&&a>0&&!isNaN(j)&&j>0)?Math.round(a*j):0;' +
    '    if(jt>0)jigaTot+=jt;' +
    '    csv+=[i+1,\'="\'+d.pnu+\'"\',d.sido,d.sgg,d.emd,d.ri,d.jibun,d.jimok,fmt(d.area),fmt(d.jiga),jt>0?jt.toLocaleString():"",d.uname,d.dgm_nm' +
    '    ].map(function(f){return\'"\'+String(f).replace(/"/g,\'""\')+\'"\';}).join(",")+\"\\n\";' +
    '  });' +
    '  csv+=\'"\'+_data.length+\'í•„ì§€ í•©ê³„","","","","","","","","\'+Math.round(tot).toLocaleString()+\'","","\'+jigaTot.toLocaleString()+\'","",""\'+\"\\n\";' +
    '  var b=new Blob([csv],{type:"text/csv;charset=utf-8"});' +
    '  var u=URL.createObjectURL(b);' +
    '  var a=document.createElement("a");a.href=u;a.download="í† ì§€ì¡°ì„œ_'+new Date().toISOString().slice(0,10)+'.csv";' +
    '  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);' +
    '}' +
    '<\/script>' +
    '</body></html>';

  var win = window.open('', '_blank', 'width=1050,height=680,scrollbars=yes,resizable=yes');
  win.document.write(html);
  win.document.close();
}

/* ===================================================
   CSV ë‚´ë³´ë‚´ê¸°
=================================================== */
function exportToCSV() {
  if (!collectedLandInfo.length) { showMsg("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "err"); return; }
  var fmt = function(v){ return (v && !isNaN(v)) ? Number(v).toLocaleString() : (v||''); };
  var csv = "\uFEFFìˆœë²ˆ,í•„ì§€ë²ˆí˜¸(PNU),ì‹œë„,ì‹œêµ°êµ¬,ìë©´ë™,ë¦¬,ì§€ë²ˆ,ì§€ëª©,ë©´ì (ã¡),ê³µì‹œì§€ê°€(ì›/ã¡),ê³µì‹œì§€ê°€ ì†Œê³„(ì›),ìš©ë„ì§€ì—­,ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­,êµ­í† í™˜ê²½ì„±í‰ê°€ë“±ê¸‰,ìƒíƒœìì—°ë„ë“±ê¸‰\n";
  var totalArea = 0, totalJigaCSV = 0;
  collectedLandInfo.forEach(function(d, idx) {
    var area = parseFloat(d.area_ || d.parea || 0);
    if (!isNaN(area)) totalArea += area;
    var jigaNum = parseFloat(String(d.jiga || '').replace(/,/g, ''));
    var jigaSub = (!isNaN(area) && area > 0 && !isNaN(jigaNum) && jigaNum > 0) ? Math.round(area * jigaNum) : 0;
    if (jigaSub > 0) totalJigaCSV += jigaSub;
    csv += [
      idx + 1,
      '="' + (d.pnu||'') + '"',
      d.sido_nm||'', d.sgg_nm||'', d.emd_nm||'', d.ri_nm||'',
      d.jibun||'', d.jimok||'',
      fmt(d.area_||d.parea),
      fmt(d.jiga),
      jigaSub > 0 ? jigaSub.toLocaleString() : '',
      d.uname||'', d.dgm_nm||'',
      d.ecvam_gr||'', d.bio_gr||''
    ].map(function(f){ return '"' + String(f).replace(/"/g,'""') + '"'; }).join(',') + '\n';
  });
  // í•©ê³„ í–‰ (15ì»¬ëŸ¼)
  csv += '"í•©ê³„","","","","","","","","' + Math.round(totalArea).toLocaleString() + '","","' + (totalJigaCSV > 0 ? totalJigaCSV.toLocaleString() : '') + '","","","",""\n';
  var blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url; a.download = 'í† ì§€ì¡°ì„œ_' + new Date().toISOString().slice(0,10) + '.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showMsg("âœ… CSV íŒŒì¼(" + collectedLandInfo.length + "ê±´)ì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.", "ok");
}

/* ===================================================
   ì´ë²¤íŠ¸
=================================================== */
function setupEvents() {
  $("#addrInput").on('keydown', function(e){
    if (e.key === 'Enter') searchAddress();
    if (e.key === 'Escape') closeAddrResults();
  });
  // ëª¨ë°”ì¼: í‚¤ë³´ë“œ ì™¸ë¶€ í´ë¦­ ì‹œ ê²€ìƒ‰ê²°ê³¼ ë‹«ê¸°
  $(document).on('click', '#ol3map, #vmap', function(){ closeAddrResults(); });
  // ëª¨ë°”ì¼ í…Œì´ë¸” ìŠ¤í¬ë¡¤ ì‹œ ê·¸ë¼ë°ì´ì…˜ íŒíŠ¸ ì œê±°
  $(document).on('scroll', '#mobLandTableWrap', function(){
    if ($(this).scrollLeft() > 20) $(this).css('--mob-hint','0');
  });
  // ëª¨ë°”ì¼ í…Œì´ë¸” í–‰ í´ë¦­ â†’ í•´ë‹¹ í† ì§€ ì§€ë„ì—ì„œ í™•ì¸ (íŒ¨ë„ ìœ ì§€)
  $(document).on('click', '#mobLandTbody tr', function(e) {
    if ($(e.target).hasClass('mob-del-btn')) return;
    var pnu = $(this).data('pnu');
    var d = collectedLandInfo.find(function(x){ return x.pnu === pnu; });
    if (!d || !d._lon || !d._lat) return;
    var label = [d.emd_nm, d.ri_nm, d.jibun].filter(Boolean).join(' ');
    moveTo(d._lon, d._lat);
    showMsg("ğŸ“ " + label + " ìœ„ì¹˜ë¡œ ì´ë™", "ok");
  });
  document.addEventListener('scroll', function(e){
    if (e.target && e.target.id === 'mobLandTableWrap' && e.target.scrollLeft > 20) {
      e.target.style.setProperty('--hide-hint','1');
      // í•œ ë²ˆ ìŠ¤í¬ë¡¤í•˜ë©´ ::after ì œê±°ë¥¼ ìœ„í•œ class ì¶”ê°€
      e.target.classList.add('scrolled');
    }
  }, true);
}

/* ===================================================
   ìœ í‹¸
=================================================== */
function showMsg(msg, type) {
  var $b = $("#statusBar");
  $b.removeClass("ok err").addClass(type||'').text(msg).show();
  clearTimeout($b.data('tid'));
  $b.data('tid', setTimeout(function(){ $b.fadeOut(); }, 4000));
}

function dist(lon1,lat1,lon2,lat2) {
  var R=6371000, f1=lat1*Math.PI/180, f2=lat2*Math.PI/180,
      df=(lat2-lat1)*Math.PI/180, dl=(lon2-lon1)*Math.PI/180;
  var a=Math.sin(df/2)*Math.sin(df/2)+Math.cos(f1)*Math.cos(f2)*Math.sin(dl/2)*Math.sin(dl/2);
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function getCenter(geom) {
  try {
    var coords = geom.type==='MultiPolygon' ? geom.coordinates[0][0] : geom.coordinates[0];
    var sx=0, sy=0;
    coords.forEach(function(p){ sx+=p[0]; sy+=p[1]; });
    return [sx/coords.length, sy/coords.length];
  } catch(e){ return [0,0]; }
}

/* ===================================================
   ì§€ë„ ë§ˆìš°ìŠ¤ ì˜¤ë²„ íˆ´íŒ (2D ì „ìš©)
=================================================== */
function initHoverTooltip() {
  var $tip = $('#mapTooltip');

  map2d.on('pointermove', function(evt) {
    if (currentMapType !== '2d' || !isLandParcelActive) { $tip.hide(); return; }
    var px = evt.pixel;
    $tip.css({ left: (px[0] + 16) + 'px', top: (px[1] - 10) + 'px' });
    var ll = ol.proj.toLonLat(evt.coordinate);
    clearTimeout(hoverTimer);
    hoverTimer = setTimeout(function() { fetchHoverInfo(ll[0], ll[1]); }, 320);
  });

  document.getElementById('ol3map').addEventListener('mouseleave', function() {
    clearTimeout(hoverTimer);
    $tip.hide();
  });
}

function fetchHoverInfo(lon, lat) {
  var hk = lon.toFixed(4) + '_' + lat.toFixed(4);
  if (hoverCache[hk] !== undefined) {
    if (hoverCache[hk]) showHoverTooltip(hoverCache[hk]);
    else $('#mapTooltip').hide();
    return;
  }
  var buf = 0.00012;
  var bbox = (lon-buf)+','+(lat-buf)+','+(lon+buf)+','+(lat+buf);
  $.ajax({
    type: 'get',
    url: 'https://api.vworld.kr/req/wfs',
    data: {
      key: apiKey,
      domain: window.location.hostname || 'localhost',
      SERVICE: 'WFS', version: '1.1.0', request: 'GetFeature',
      TYPENAME: 'lt_c_landinfobasemap',
      OUTPUT: 'text/javascript',
      SRSNAME: 'EPSG:4326',
      BBOX: bbox,
      MAXFEATURES: 5
    },
    dataType: 'jsonp',
    timeout: 3000,
    success: function(data) {
      var feats = (data && data.features) || [];
      var best = feats.filter(function(f){ return f.geometry && pointInGeom(lon, lat, f.geometry); })[0]
                 || feats[0] || null;
      if (best) {
        var p = best.properties;
        var info = [p.emd_nm, p.ri_nm, p.jibun].filter(Boolean).join(' ')
                   + (p.jimok ? '  [' + p.jimok + ']' : '');
        hoverCache[hk] = info;
        showHoverTooltip(info);
      } else {
        hoverCache[hk] = null;
        $('#mapTooltip').hide();
      }
    },
    error: function() { $('#mapTooltip').hide(); }
  });
}

function showHoverTooltip(text) {
  $('#mapTooltip').text(text).show();
}

function debounce(fn, wait) {
  var t;
  return function() {
    var a=arguments, ctx=this;
    clearTimeout(t);
    t = setTimeout(function(){ fn.apply(ctx,a); }, wait);
  };
}

/* â”€â”€ ë„ì›€ë§ ëª¨ë‹¬ â”€â”€ */
window.openHelp = function() { document.getElementById('helpModal').classList.add('open'); document.body.style.overflow='hidden'; };
window.closeHelp = function() { document.getElementById('helpModal').classList.remove('open'); document.body.style.overflow=''; };
window.closeHelpOutside = function(e) { if (e.target.id === 'helpModal') window.closeHelp(); };
document.addEventListener('keydown', function(e){ if (e.key === 'Escape') window.closeHelp(); });
</script>
</body>
</html>
